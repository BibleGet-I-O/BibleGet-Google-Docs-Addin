<? 
  var propsService = PropertiesService.getUserProperties();
  var recentSelectedVersionsProp = propsService.getProperty("RecentSelectedVersions");
  if(recentSelectedVersionsProp===null){
    recentSelectedVersions = [];
  }
  else{
    recentSelectedVersions = JSON.parse(recentSelectedVersionsProp);
  }
  //Logger.log("recentSelectedVersions = "+recentSelectedVersions.join(','));
  
  let locale = 'en';
  try{ locale = getUserLocale(); }
  catch(e){ alertMe("Error: " + e.message + "\r\nFile: " + e.fileName + "\r\nLine: " + e.lineNumber); }
  
  var scriptProperties = PropertiesService.getScriptProperties();
  if(scriptProperties.getProperty("versions")===null){
    setScriptProps();
  }
  var propVersions = scriptProperties.getProperty("versions");
  var versions = JSON.parse(propVersions);
  var versionsbylang = {};
  var langs = [];
  for(var i in versions){
    //i corresponds with the abbreviation "sigla"
    var info = versions[i].split("|");
    var fullname = info[0];
    var year = info[1];
    var lang = _c(info[2]);
    lang = _l(lang,locale);
    if(versionsbylang.hasOwnProperty(lang)){
      if(versionsbylang[lang].hasOwnProperty(i)){
        //how can that be?
      }
      else{
        versionsbylang[lang][i] = {"fullname":fullname,"year":year};
      }
    }
    else{
      versionsbylang[lang] = {};
      langs.push(lang);
      versionsbylang[lang][i] = {"fullname":fullname,"year":year};
    }
  }
  //docLog(JSON.stringify(versionsbylang));
  var direction = 1; // 1 asc   -1 desc
  langs.sort(function(a, b){
    return a.localeCompare(b,locale) === 1? direction : -1 * direction;
  });
?>
<!DOCTYPE html>
<head>
  <base target="_blank">
  <meta charset="UTF-8">
  <?!= include("Stylesheet"); ?>
  <style>
  .downLdIco {
    background-image: url(<?!= include('DownloadIcon'); ?>);
    background-size: cover;
    width: 20px;
    height: 20px;
    position: relative;
    top: 4px;
    right: 3px;
    display: inline-block;
  }
  .searchIco {
    background-image: url(<?!= include('SearchIcon'); ?>);
    background-size: cover;
    width: 20px;
    height: 20px;
    position: relative;
    top: 4px;
    right: 3px;
    display: inline-block;
  }
  </style>
</head>
<body>
<div class="spinner lds-ring" id="spinner-gif"><div></div><div></div><div></div><div></div></div>
<div class="spinner" id="spinner-bg"></div>

<div class="sidebar branding-below">
    <h3><?=__("Get bible quotes",locale)?></h3>
    <div class="block form-group">
      <label class="gapp-addon" for="text-version"><b><?=__("Versions available:",locale)?></b></label>
      <select class="gapp-addon" id="text-version" multiple>
        <? for(var q in langs){ ?>
        <optgroup label="-<?=langs[q]?>-">
          <?for(var s in versionsbylang[langs[q]]){?>
          <option value="<?=s?>" <?if(recentSelectedVersions.indexOf(s) != -1){?>SELECTED<?}?>><?=s+' â€” '+versionsbylang[langs[q]][s]["fullname"]+' ('+versionsbylang[langs[q]][s]["year"]+')'?></option>
          <?}?>
        </optgroup>
        <?}?>
      </select>
      <div><?=__("Versions selected:",locale)?> <span id="selectedversions" <?if(recentSelectedVersions.length<1){?>class="empty">none<?}else{?>><?=recentSelectedVersions.join(',')?><?}?></span></div>
    </div>    
    <div class="block form-group" style="margin-top:20px;">
      <label class="gapp-addon"><b><?=__('Insert citation',locale)?></b></label>
      <div class="inline form-group">
        <input class="gapp-addon" id="bibleget-search" type="search" placeholder="<?=__("e.g. Matthew 1:1-10,13-15",locale)?>" />
        <button id="btn-get-bible-quote" class="action gapp-addon"><span class="downLdIco">&nbsp;</span><?=__("Get verses",locale)?></button>
      </div>
    </div>
    <div class="block form-group" style="margin-top:10px;">
      <label class="gapp-addon"><b><?=__('Find verses by keyword',locale)?></b></label>
      <div class="inline form-group">
        <input class="gapp-addon" id="bibleget-fulltextsearch" type="search" placeholder="<?=__("e.g. Creation",locale)?>" />
        <button id="btn-bible-search" class="action gapp-addon"><span class="searchIco">&nbsp;</span><?=__("Search",locale)?></button>
      </div>
    </div>
</div>

<div class="sidebar bottom">
  <? let usrProperties = propsService.getProperties();
     if(usrProperties.hasOwnProperty('RientroSinistro') || usrProperties.hasOwnProperty('BookChapterAlignment') || usrProperties.hasOwnProperty('VerseNumberAlignment') || usrProperties.hasOwnProperty('VerseTextAlignment') || usrProperties.hasOwnProperty('Interlinea') ){ ?>
  <div style="text-align:center;margin-top:16px;"><button title="This will remove all of your current user preferences and reset them to default. Resort to this if you cannot open the settings / preferences window." class="button" id="RESET_DEFAULT_USERPROPS"><?=__('RESET PREFERENCES TO DEFAULT OPTIONS',locale)?></button></div>
  <?  } ?>
  <div style="background:linear-gradient(white,gray,lightblue,black);color:White;font-weight:bold;text-shadow:3px 3px 3px Black;padding:1px;vertical-align:middle;"><a target="_blank" href="https://www.bibleget.io"><?!= include("BibleIcon_32"); ?></a><span style="position:relative;top:-9px;">BibleGet I/O for Google Docs v.<?!=VERSION?></span></div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.1/jquery-ui.min.js"></script>

<script>
var queryServer = function(goodqueries){
  goodqueries = goodqueries || [];
  if(goodqueries.length===0){
    $('.spinner').hide();
    return false;
  }else{
    let finalquery = goodqueries.join(';');
    if(finalquery != ''){
      let versions = $("select#text-version :selected").map(function(){ return this.value; }).get().join(',');
      if(versions.length<1){
        alertMe('<?!=__("Please select a version.",locale)?>');
        return false;
      }else{
        let payload = {'query':finalquery,'version':versions};
        google.script.run.withSuccessHandler(parseResponse).fetchData(payload);
      }
    }
  }
},
parseResponse = function(response){
  if(response===false){
    $('.spinner').hide();
  }
  var myjson = {};
  myjson = JSON.parse(response);
  if(myjson.hasOwnProperty("results")){
    //google.script.run.docLog("yayy we have results!");
    parseResults(myjson);
  }  
  if(myjson.hasOwnProperty("errors")){
    parseErrors(myjson.errors);
  }
},
parseResults = function(myjson){
    //google.script.run.docLog(JSON.stringify(myjson));
    google.script.run.withSuccessHandler(hideSpinner).docInsert(myjson);
},
hideSpinner = function(){
    $('.spinner').hide();
},
parseErrors = function(errors){
    if(errors.length < 1){ return false; }
    else{
      var errmessage = '';
      for(var i=0;i<errors.length;i++){
        errmessage += '(' + errors[i].errNum + ') : ' + errors[i].errMessage+'\n';
      }
      if(errmessage !== ''){ 
        //we must hide the spinner before the alert opens, because the alert interrupts the script!
        $('.spinner').hide();
        alertMe('[Server Error Message] '+errmessage);
      }
    }
},
queryClean = function(query){
  // enforce query rules
  if(query===''){ 
    alertMe('<?!=__("I cannot send an empty query.",locale)?>');
  }
  query = query.trim().replace(/ /g,'');
      
  if(query.indexOf(':') != -1 && query.indexOf('.') != -1){
    alertMe('<?!=__("Mixed notations have been detected. Please use either english notation or european notation.",locale)?> <'+query+'>');
  }
  else if(query.indexOf(':') != -1){ //if english notation is detected, translate it to european notation
    if(query.indexOf(',') != -1){
      query = query.replace(/,/g,'.');
    }
    query = query.replace(/:/g,',');
  }
  return query.split(';').filter(function(n){ return n !== ""; });
},
alertMe = function(errmex){
  $('.spinner').hide();
  google.script.run.alertMe(errmex); 
  return false; 
},
runKeywordSearch = function(keyword){
  let version = $("select#text-version :selected").map(function(){ return this.value; }).get();
  if(version.length<1){
    $('.spinner').hide();
    alertMe('<?!=__("Please select a version.",locale)?>');
    return false;
  }else if(version.length>1){
    $('.spinner').hide();
    alertMe('<?!=__("When doing a search by keyword, you cannot select more than one version",locale)?>');
    return false;
  }
  else{
    let payload = {'query':'keywordsearch','version':version[0],'keyword':keyword.replace(/\W/g, '')}; //remove non-word characters
    google.script.run.withSuccessHandler(hideSpinner).fetchSearchResults(payload);
  }
};

$(document).ready(function(){
    $('.spinner').hide();
    $('#text-version').change(function(){
      let selectedversions = $(this).val();
      if(selectedversions===null){
        if($('#selectedversions').hasClass("empty")===false){$('#selectedversions').addClass("empty");}
        $('#selectedversions').text('none');
        selectedversions = [];
      }
      else{
        if($('#selectedversions').hasClass("empty")){$('#selectedversions').removeClass("empty");}
        $('#selectedversions').text(selectedversions.join(','));
       }
       google.script.run.setUserProperty("RecentSelectedVersions",JSON.stringify(selectedversions));
    });
    
    $('#btn-get-bible-quote').click(function(){
      $('.spinner').show();      
      let versions = $("#text-version").val();
      if(versions===null){
        $('.spinner').hide();
        alertMe('<?!=__('Please select a version.',locale)?>');
        return false;
      }
      let query = $('#bibleget-search').val();
      let queries = queryClean(query);      
      google.script.run.withSuccessHandler(queryServer).processQueries(queries,versions);
    });
    
    $('#btn-bible-search').on('click',function(){
      let $keyword = $('#bibleget-fulltextsearch').val();
      if($keyword.length < 3){  
        alertMe('<?!=__('Please use at least 3 characters when searching for words or partial word matches.',locale)?>');
      }
      else{
        $('.spinner').show();
        runKeywordSearch($keyword);
      }
    });
    
    $('#RESET_DEFAULT_USERPROPS').on('click',function(){
      //$('.spinner').show();
      google.script.run.resetUserProperties();
    });
    
});
</script>

</body>