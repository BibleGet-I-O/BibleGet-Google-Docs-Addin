<? 
  //FOR WHATEVER STRANGE REASON, ON ONE GMAIL ACCOUNT I'M GETTING AN ERROR
  //WHEN OPENING THE SETTINGS DIALOG, ABOUT AN UNEXPEXTED 'u' CHARACTER???
  //ONLY SEEMS TO HAPPEN WITH THE BIBLEGET ACCOUNT AND NOT OTHER ACCOUNTS
    
  let locale = 'en';
  try{ locale = getUserLocale(); }
  catch(e){ alertMe("Error: " + e.message + "\r\nFile: " + e.fileName + "\r\nLine: " + e.lineNumber); }
  
  var scriptProperties = PropertiesService.getScriptProperties();
  if(scriptProperties.getProperty("languages")===null || scriptProperties.getProperty("versions")===null){
    //consoleLog('now setting properties from Settings.html');
    setScriptProps();
  }
  
  var propLangs = scriptProperties.getProperty("languages");
  //consoleLog(propLangs);
  languages = JSON.parse(propLangs);
  
  var propVersions = scriptProperties.getProperty("versions");
  //consoleLog(propVersions);
  var versions = JSON.parse(propVersions);
  
  if(CURRENTSTATE == ADDONSTATE.DEVELOPMENT){ consoleLog('now running getUserProperties from within Settings.html'); }  
  
  var userProperties = getUserProperties(true); //will be a pure JSON obj, without any stringified values (nostringify=true)
  if(userProperties === false){
    //there has been some error in getting or setting properties in the properties service, we will resort to default values to avoid blocking the ui completely
    userProperties = DefaultUserProperties;
  }
  if(CURRENTSTATE == ADDONSTATE.DEVELOPMENT){ consoleLog('getUserProperties has been run from within Settings.html'); }
  
  //DEFINE devicePixelRatio constant useful for drawing the canvas with image of ruler precisely, correctly, sharply
  const dPR = 1.0; //a typical screen will have a ratio of 1.0 == 96 dpi 
                   //some lower quality graphics display might have for example a ratio of 0.78125 = 75 dpi
                   //high retina displays can have a ratio of 2.0 = 192 dpi
                   //my laptop has 1.25 = 120 dpi 
                   //TODO: my tests however show that on my display 115 dpi is actually closer to 1 physical inch. is it just my display? 
                   //      If I compensate for my display, will the compensation work for other displays? Need to do some testing on other displays.
                   //In any we cannot actually know window.devicePixelRatio at this point, because it is only available to client javascript, so here it doesn't mean much of anything
                   //we will therefor retrieve this value in the client javascript using window.devicePixelRatio and update both css properties and accordingly!!!
  
  if(CURRENTSTATE == ADDONSTATE.DEVELOPMENT){ consoleLog('left and right indent have been set based on userproperties in Settings.html'); }   

  var wrap1 = '', wrap2 = '', wrap3 = '', wrap4 = '';
  switch(userProperties.LayoutPrefs.BIBLEVERSIONWRAP){
    case BGET.WRAP.NONE:
      break;
    case BGET.WRAP.PARENTHESES:
      wrap1 = '(';
      wrap2 = ')';
      break;
    case BGET.WRAP.BRACKETS:
      wrap1 = '[';
      wrap2 = ']';
      break;
  } 
  switch(userProperties.LayoutPrefs.BOOKCHAPTERWRAP){
    case BGET.WRAP.NONE:
      break;
    case BGET.WRAP.PARENTHESES:
      wrap3 = '(';
      wrap4 = ')';
      break;
    case BGET.WRAP.BRACKETS:
      wrap3 = '[';
      wrap4 = ']';
      break;
  } 
  if(CURRENTSTATE == ADDONSTATE.DEVELOPMENT){
    consoleLog('Settings.html: wraps have been prepared for bibleversion (wrap1 = '+wrap1+',wrap2 = '+wrap2+') and bookchapter (wrap3 = '+wrap3+',wrap4 = '+wrap4+') based on user preferences (userProperties.LayoutPrefs.BIBLEVERSIONWRAP = '+userProperties.LayoutPrefs.BIBLEVERSIONWRAP+') ');
    consoleLog('typeof userProperties.LayoutPrefs.BIBLEVERSIONWRAP = '+(typeof userProperties.LayoutPrefs.BIBLEVERSIONWRAP)+', typeof BGET.WRAP.PARENTHESES = '+(typeof BGET.WRAP.PARENTHESES));
  }   
  
  let bkChptr1Sam213 = '',
      bkChptrPs11412 = '';
  switch(userProperties.LayoutPrefs.BOOKCHAPTERFORMAT){
    case BGET.FORMAT.BIBLELANG:
      bkChptr1Sam213 = "I Samuelis 2";
      bkChptrPs11412 = "Psalmorum 114";
      break;
    case BGET.FORMAT.BIBLELANGABBREV:
      bkChptr1Sam213 = "ISam 2";
      bkChptrPs11412 = "Ps 114";
      break;
    case BGET.FORMAT.USERLANG: 
      bkChptr1Sam213 = __('ISamuelis2',locale);
      bkChptrPs11412 = __('Psalmorum114',locale);
      break;
    case BGET.FORMAT.USERLANGABBREV:
      bkChptr1Sam213 = __('ISam2',locale);
      bkChptrPs11412 = __('Ps114',locale);
      break;
  }
  if(userProperties.LayoutPrefs.BOOKCHAPTERFULLQUERY){
    bkChptr1Sam213 += ((locale=='en' ? ':' : ',') + '1-3');
    bkChptrPs11412 += ((locale=='en' ? ':' : ',') + '1-2');
  }
  
  let ISam2_1 = 'Et oravit Anna et ait: Exsultavit cor meum in Domino, exaltatum est cornu meum in Deo meo; dilatatum est os meum super inimicos meos, quoniam laetata sum in salutari tuo.';
  let ISam2_2 = 'Non est sanctus ut est Dominus; neque enim est alius extra te, et non est fortis sicut Deus noster.';
  let ISam2_3 = 'Nolite multiplicare loqui sublimia gloriantes. Recedant superba de ore vestro, quia Deus scientiarum Dominus est, et ab eo ponderantur actiones.';
  let Ps114_1 = 'In exitu Israel de Aegypto, domus Iacob de populo barbaro,';
  let Ps114_2 = 'factus est Iuda sanctuarium eius, Israel potestas eius.';
  
  var nonUniqueStr = userProperties.ParagraphStyles.FONT_FAMILY;
      nonUniqueStr += bkChptr1Sam213;
      nonUniqueStr += bkChptrPs11412;
      nonUniqueStr += ISam2_1;
      nonUniqueStr += ISam2_2;
      nonUniqueStr += ISam2_3;
      nonUniqueStr += Ps114_1;
      nonUniqueStr += Ps114_2;
  //consoleLog(nonUniqueStr);
  var UniqueStr = makeUnique(nonUniqueStr);
  if(CURRENTSTATE == ADDONSTATE.DEVELOPMENT){
    consoleLog('UniqueStr has been set based on pagraphstyles.font_family in Settings.html');
  }   

  var PreviewBox = '<fieldset class="fieldset-results"><legend><b>' + __('Preview',locale) + '</b></legend>';
      PreviewBox += '<canvas class="previewRuler"></canvas>';
      PreviewBox += '<p class="bibleversion showtop" style="display:'+(userProperties.LayoutPrefs.SHOWBIBLEVERSION==BGET.VISIBILITY.SHOW && userProperties.LayoutPrefs.BIBLEVERSIONPOSITION==BGET.POS.TOP?'block':'none')+';"><span class="bcWrap">' + wrap1 + '</span>NVBSE<span class="bcWrap">' + wrap2 + '</span></p>';
      PreviewBox += '<div class="bookChapterWrapper">';
      PreviewBox += (userProperties.LayoutPrefs.BOOKCHAPTERPOSITION==BGET.POS.TOP) ? '<span class="bookchapter" style="display:block;"><span class="bcWrap">' + wrap3 + '</span><span class="bcText1Sam">' + bkChptr1Sam213 + '</span><span class="bcWrap">' + wrap4 + '</span></span>' : '';
      PreviewBox += '<div class="liveview-quote">';
      PreviewBox += '<span class="versenumber" style="display:'+(userProperties.LayoutPrefs.SHOWVERSENUMBERS===BGET.VISIBILITY.SHOW ? 'inline' : 'none')+';">1</span><span class="versetext">'+ ISam2_1 +'</span>';
      PreviewBox += '<span class="versenumber" style="display:'+(userProperties.LayoutPrefs.SHOWVERSENUMBERS===BGET.VISIBILITY.SHOW ? 'inline' : 'none')+';">2</span><span class="versetext">'+ ISam2_2 +'</span>';
      PreviewBox += '<span class="versenumber" style="display:'+(userProperties.LayoutPrefs.SHOWVERSENUMBERS===BGET.VISIBILITY.SHOW ? 'inline' : 'none')+';">3</span><span class="versetext">'+ ISam2_3 +'</span>';
      PreviewBox += (userProperties.LayoutPrefs.BOOKCHAPTERPOSITION==BGET.POS.BOTTOMINLINE) ? '<span class="bookchapter" style="margin-left:6px;"><span class="bcWrap">' + wrap3 + '</span><span class="bcText1Sam">' + bkChptr1Sam213 + '</span><span class="bcWrap">' + wrap4 + '</span></span>' : '';
      PreviewBox += '</div>';
      PreviewBox += (userProperties.LayoutPrefs.BOOKCHAPTERPOSITION==BGET.POS.BOTTOM) ? '<span class="bookchapter" style="display:block;"><span class="bcWrap">' + wrap3 + '</span><span class="bcText1Sam">' + bkChptr1Sam213 + '</span><span class="bcWrap">' + wrap4 + '</span></span>' : '';
      PreviewBox += '</div>';
      PreviewBox += '<div class="bookChapterWrapper">';
      PreviewBox += (userProperties.LayoutPrefs.BOOKCHAPTERPOSITION==BGET.POS.TOP) ? '<span class="bookchapter" style="display:block;"><span class="bcWrap">' + wrap3 + '</span><span class="bcTextPs">' + bkChptrPs11412 + '</span><span class="bcWrap">' + wrap4 + '</span></span>' : '';
      PreviewBox += '<div class="liveview-quote">';
      PreviewBox += '<span class="versenumber" style="display:'+(userProperties.LayoutPrefs.SHOWVERSENUMBERS===BGET.VISIBILITY.SHOW ? 'inline' : 'none')+';">1</span><span class="versetext">'+ Ps114_1 +'</span>';
      PreviewBox += '<span class="versenumber" style="display:'+(userProperties.LayoutPrefs.SHOWVERSENUMBERS===BGET.VISIBILITY.SHOW ? 'inline' : 'none')+';">2</span><span class="versetext">factus est Iuda sanctuarium eius, Israel potestas eius.</span>';
      PreviewBox += (userProperties.LayoutPrefs.BOOKCHAPTERPOSITION==BGET.POS.BOTTOMINLINE) ? '<span class="bookchapter" style="margin-left:6px;"><span class="bcWrap">' + wrap3 + '</span><span class="bcTextPs">' + bkChptrPs11412 + '</span><span class="bcWrap">' + wrap4 + '</span></span>' : '';
      PreviewBox += '</div>';
      PreviewBox += (userProperties.LayoutPrefs.BOOKCHAPTERPOSITION==BGET.POS.BOTTOM) ? '<span class="bookchapter" style="display:block;"><span class="bcWrap">' + wrap3 + '</span><span class="bcTextPs">' + bkChptrPs11412 + '</span><span class="bcWrap">' + wrap4 + '</span></span>' : '';
      PreviewBox += '</div>';
      PreviewBox += '<p class="bibleversion showbottom" style="display:'+(userProperties.LayoutPrefs.SHOWBIBLEVERSION===BGET.VISIBILITY.SHOW && userProperties.LayoutPrefs.BIBLEVERSIONPOSITION===BGET.POS.BOTTOM?'block':'none')+';"><span class="bcWrap">' + wrap1 + '</span>NVBSE<span class="bcWrap">' + wrap2 + '</span></p>';
      PreviewBox += '</fieldset>';
  if(CURRENTSTATE == ADDONSTATE.DEVELOPMENT){
    consoleLog('starting HTML output in Settings.html');
  }   

?>
<!DOCTYPE html>
<head>
  <meta charset="UTF-8">
  <link id="gfFontFamily" href="https://fonts.googleapis.com/css?family=<?!= userProperties.ParagraphStyles.FONT_FAMILY ?>&text=<?!= UniqueStr ?>" rel="stylesheet" />
<?!= include("Stylesheet"); ?>
<style>

.fieldset-results{
 border: 1px groove LightBlue;
 border-radius:6px;
 /*padding:0px 8px 3px 6px;*/
 /*background-color:#EEEEFF;*/
 min-height: 60px;
 max-height: 250px;
 overflow-y:auto;
 text-align: center;
}

.fieldset-results .bibleversion, .fieldset-results .bookChapterWrapper { /* .bookChapterWrapper wraps .bookchapter and .liveview-quote*/
  box-sizing: border-box;
  margin: 0px auto;
  padding-left: 35px;
  padding-right:35px;
}

.bibleversion, .bookchapter {
  font-size: <?!= userProperties.BookChapterStyles.FONT_SIZE ?>px;
  font-weight: <? if(userProperties.BookChapterStyles.BOLD){ ?>bold<? }else{ ?>normal<?} ?>;
  font-style: <? if(userProperties.BookChapterStyles.ITALIC){ ?>italic<? }else{ ?>normal<?} ?>;
  text-decoration:<? if(!userProperties.BookChapterStyles.UNDERLINE && !userProperties.BookChapterStyles.STRIKETHROUGH){ ?> none<? } else{ if (userProperties.BookChapterStyles.UNDERLINE){?> underline<?} if(userProperties.BookChapterStyles.STRIKETHROUGH){?> line-through<?} }?>;
  color: <?!= userProperties.BookChapterStyles.FOREGROUND_COLOR ?>;
  background-color: <?!= userProperties.BookChapterStyles.BACKGROUND_COLOR ?>;
  padding-top:0px;
  padding-bottom: 3px;
  font-family: <?!= userProperties.ParagraphStyles.FONT_FAMILY ?>;
  position: relative;
}

.bibleversion{
  text-align: <?!=userProperties.LayoutPrefs.BIBLEVERSIONALIGNMENT?>;
}

.bookchapter {
  text-align: <?!=userProperties.LayoutPrefs.BOOKCHAPTERALIGNMENT?>;
  top: <?!= userProperties.BookChapterStyles.VALIGN==BGET.VALIGN.NORMAL ? 0 : (userProperties.BookChapterStyles.VALIGN==BGET.VALIGN.SUPERSCRIPT ? -4 : 4) ?>px;
}

.liveview-quote { /* wraps .versenumber and .versetext */
  line-height: <?!= userProperties.ParagraphStyles.LINEHEIGHT?>em;
  text-align: <?!=userProperties.ParagraphStyles.PARAGRAPHALIGN?>;
  padding-top: 3px;
  padding-bottom: 3px;
  font-family: <?!= userProperties.ParagraphStyles.FONT_FAMILY ?>;
}

.versenumber{
  font-size: <?!= userProperties.VerseNumberStyles.FONT_SIZE ?>px;
  font-weight: <? if(userProperties.VerseNumberStyles.BOLD){ ?>bold<? }else{ ?>normal<? } ?>; 
  font-style: <? if(userProperties.VerseNumberStyles.ITALIC){ ?>italic<? }else{ ?>normal<?} ?>;
  text-decoration:<? if(!userProperties.VerseNumberStyles.UNDERLINE && !userProperties.VerseNumberStyles.STRIKETHROUGH){ ?> none<? } else{ if (userProperties.VerseNumberStyles.UNDERLINE){?> underline<?} if(userProperties.VerseNumberStyles.STRIKETHROUGH){?> line-through<?} }?>;
  color: <?!= userProperties.VerseNumberStyles.FOREGROUND_COLOR ?>;
  background-color: <?!= userProperties.VerseNumberStyles.BACKGROUND_COLOR ?>;
  position: relative;
  top: <?!= userProperties.VerseNumberStyles.VALIGN==BGET.VALIGN.NORMAL ? 0 : (userProperties.VerseNumberStyles.VALIGN==BGET.VALIGN.SUPERSCRIPT ? -4 : 4) ?>px;
  padding-left: 3px;
}
.versetext{
  font-size: <?!= userProperties.VerseTextStyles.FONT_SIZE ?>px;
  font-weight: <? if(userProperties.VerseTextStyles.BOLD){ ?>bold<? }else{ ?>normal<? } ?>;
  font-style: <? if(userProperties.VerseTextStyles.ITALIC){ ?>italic<? }else{ ?>normal<?} ?>;
  text-decoration:<? if(!userProperties.VerseTextStyles.UNDERLINE && !userProperties.VerseTextStyles.STRIKETHROUGH){ ?> none<? } else{ if (userProperties.VerseTextStyles.UNDERLINE){?> underline<?} if(userProperties.VerseTextStyles.STRIKETHROUGH){?> line-through<?} }?>;
  color: <?!= userProperties.VerseTextStyles.FOREGROUND_COLOR ?>;
  background-color: <?!= userProperties.VerseTextStyles.BACKGROUND_COLOR ?>;
  position: relative;
  top: <?!= userProperties.VerseTextStyles.VALIGN==BGET.VALIGN.NORMAL ? 0 : (userProperties.VerseTextStyles.VALIGN==BGET.VALIGN.SUPERSCRIPT ? -4 : 4) ?>px;
}


table, td, a {
	color: #000;
	font: normal normal 12px Verdana, Geneva, Arial, Helvetica, sans-serif;
}

/* define height and width of scrollable area. Add 16px to width for scrollbar */
div.tableContainer {
	border: 1px solid #963;
	height: <? if(Object.keys(versions).length > 3){ ?>108<? }else{ ?>85<? } ?>px;
	overflow: auto;
	width: 656px
}

/* Reset overflow value to hidden for all non-IE browsers. */
html>body div.tableContainer {
	overflow: hidden;
	width: 656px
}

/* define width of table. IE browsers only                 */
div.tableContainer table {
	float: left;
	width: 637px
}

/* define width of table. Add 16px to width for scrollbar.           */
/* All other non-IE browsers.                                        */
html>body div.tableContainer table {
	width: 656px
}

/* set table header to a fixed position. WinIE 6.x only                                       */
/* In WinIE 6.x, any element with a position property set to relative and is a child of       */
/* an element that has an overflow property set, the relative value translates into fixed.    */
/* Ex: parent element DIV with a class of tableContainer has an overflow property set to auto */
thead.fixedHeader tr {
	position: relative;
}

/* set THEAD element to have block level attributes. All other non-IE browsers            */
/* this enables overflow to work on TBODY element. All other non-IE, non-Mozilla browsers */
html>body thead.fixedHeader tr {
	display: block;
}

/* make the TH elements pretty */
thead.fixedHeader th {
	background: #C96;
	border-left: 1px solid #EB8;
	border-right: 1px solid #B74;
	border-top: 1px solid #EB8;
	font-weight: normal;
	padding: 4px 3px;
	text-align: left;
}

/* make the A elements pretty. makes for nice clickable headers                */
thead.fixedHeader a, thead.fixedHeader a:link, thead.fixedHeader a:visited {
	color: #FFF;
	display: block;
	text-decoration: none;
	width: 100%;
}

/* make the A elements pretty. makes for nice clickable headers                */
/* WARNING: swapping the background on hover may cause problems in WinIE 6.x   */
thead.fixedHeader a:hover {
	color: #FFF;
	display: block;
	text-decoration: underline;
	width: 100%;
}

/* define the table content to be scrollable                                              */
/* set TBODY element to have block level attributes. All other non-IE browsers            */
/* this enables overflow to work on TBODY element. All other non-IE, non-Mozilla browsers */
/* induced side effect is that child TDs no longer accept width: auto                     */
tbody.scrollContent {
	display: block;
	height: <? if(Object.size(versions) > 3){ ?>85<? }else{ ?>62<? } ?>px;
	overflow: auto;
	width: 100%;
}

/* make TD elements pretty. Provide alternating classes for striping the table */
/* http://www.alistapart.com/articles/zebratables/                             */
tbody.scrollContent td, tbody.scrollContent tr.normalRow td {
	background: #FFF;
	border-bottom: none;
	border-left: none;
	border-right: 1px solid #CCC;
	border-top: 1px solid #DDD;
	padding: 2px 3px 3px 4px
}

tbody.scrollContent tr.alternateRow td {
	background: #EEE;
	border-bottom: none;
	border-left: none;
	border-right: 1px solid #CCC;
	border-top: 1px solid #DDD;
	padding: 2px 3px 3px 4px
}

/* define width of TH elements: 1st, 2nd, and 3rd respectively.          */
/* Add 16px to last TH for scrollbar padding. All other non-IE browsers. */
/* http://www.w3.org/TR/REC-CSS2/selector.html#adjacent-selectors        */
html>body thead.fixedHeader th {
	width: 150px
}

html>body thead.fixedHeader th + th {
	width: 400px
}

html>body thead.fixedHeader th + th + th {
	width: 106px
}

/* define width of TD elements: 1st, 2nd, and 3rd respectively.          */
/* All other non-IE browsers.                                            */
/* http://www.w3.org/TR/REC-CSS2/selector.html#adjacent-selectors        */
html>body tbody.scrollContent td {
	width: 151px
}

html>body tbody.scrollContent td + td {
	width: 400px
}

html>body tbody.scrollContent td + td + td {
	width: 105px
}

.custom-combobox {
  position: relative;
  display: inline-block;
  right: 2px;
  top: 0.5px;
}
.custom-combobox-toggle {
  position: absolute;
  top: 0;
  bottom: 0;
  margin-left: -1px;
  padding: 0;
}
.custom-combobox-input {
  margin: 0;
  padding: 7.5px 10px;
  background: -webkit-linear-gradient(top, #f5f5f5, #f1f1f1);
  background-position: 95% 50%;
  background-repeat: no-repeat;
  border: 2px inset #ccc;
}

.flexcontainer {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
}

.flexcontainer .flexitem.bibleget-font-family {
  min-width: 215px;
}

.bget-fontfamily-combobox {
  max-width: 245px;
}

.flexcontainerX {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
}

.flexcontainerV {
  display: flex;
  flex-direction: column;
  border-right: 1px groove White;
}
.flexcontainerV:last-child {
  border-right: none;
}

.flexcontainerB {
  display: flex;
  flex-direction: row;
  justify-content: center;
}

.flexitemB {
  text-align: center;
  font-size: .7em;
  padding: 0 3px;
}

.ctrlGrpLbl {
  font-weight: bold;
}

.centered {
  text-align: center;
  font-weight: bold;
  height: 3em;
}

.flexitemB .ui-controlgroup-vertical .ui-controlgroup-item {
  text-align: center;
}

/* override some jquery ui stylings to fix things up to the pixel (or fraction of a pixel!) */

ul.ui-autocomplete.ui-widget {
  max-height: 300px;
  overflow-y: scroll;
  overflow-x: hidden;
}

span.ui-checkboxradio-icon { display: none; }

.ui-button {
  line-height: 1.3em;
  min-height: 1.3em;
}

.ui-button.ui-widget.ui-checkboxradio-radio-label.ui-checkboxradio-checked.ui-state-active.ui-checkboxradio-label.ui-controlgroup-item { position:relative; top: .3px; }

.ui-selectmenu-menu.ui-front.ui-selectmenu-open li.ui-menu-item div.ui-menu-item-wrapper.ui-state-active {
  background-image: none;
  background-color: #1a73e8;
  color: White;
}

.ui-widget {
  font-size: 1em;
}

#rightIndentIncreaseBtn .material-icons,#rightIndentDecreaseBtn .material-icons {
  transform: scale(-1, 1);
}

#otherSettingsTab1 {
  margin-top: 6px;
  justify-content: space-around;
}

#otherSettingsTab1 .ui-button {
  font-size: .8em;
}
  
#messageToUser {
  border: 1px solid Gray;
  background-color: pink;
  color: Gray;
  padding: 12px;
}

<?
  if(CURRENTSTATE == ADDONSTATE.DEVELOPMENT){
    consoleLog('styles in head of document have been set in Settings.html');
  }   
?>
</style>
</head>
<body>
<div id="messageToUser"></div>
<input id="idAccountOfEffectiveUsr" type="hidden" style="display:none" value="<?!= Session.getEffectiveUser().getEmail(); ?>"/>
<script>
let failedAcctTest = function(rtrn) {
  $('.spinner').hide();
  let usrWhoLoaded = document.getElementById('idAccountOfEffectiveUsr').textContent;

  if (usrWhoLoaded !== rtrn) {
    document.getElementById('messageToUser').textContent = "<?=__('The Add-on loaded under the account:',locale)?>" + " <" + usrWhoLoaded + ">" +
      "\n\n" + "<?=__('However you are also logged into another account in this browser:',locale)?>" + " <" + rtrn + ">" +
      "\n\n" + "<?=__('Being logged into multiple accounts in the same browser session causes authorization errors.',locale)?>" +
      "\n\n" + "<?=__('In order to proceed, you must either log out of all accounts, and log back into the account that installed the add-on, or open an incognito window, log in with the account that installed the add-on and use the add-on from that window.',locale)?>" +
      "\n\n" + "<?=__('The best practice to avoid these problems is to login to your accounts using the browser\'s own account manager. That way you have a different browser session for each account that you would like to use.',locale)?>";
  }
},
successAcctTest = function(rtrn) {
  $('#messageToUser').hide();
};
</script>
<div class="spinner lds-ring" id="spinner-gif"><div></div><div></div><div></div><div></div></div>
<div class="spinner" id="spinner-bg"></div>
<input type="hidden" id="activetab" value="<?!=activetab?>" />
<div id="tabs">
  <ul>
    <li><a href="#tab1"><?=__('Text Formatting',locale)?></a></li>
    <li><a href="#tab2"><?=__('Preferred Layout',locale)?></a></li>
    <li><a href="#tab3"><?=__('Versions and Languages',locale)?></a></li>
  </ul>
  <!-- BEGIN TAB 1-->
  <div id="tab1">
    <div id="accordion">    
      <h3><b><?=__('Paragraph Styles',locale)?></b></h3>
      <div class="toolbar ui-widget-header ui-corner-bottom flexcontainer">
        <div class="flexitem">
          <span class="buttonset" title="<?!=__('Left Indent',locale)?>">
          <button id="leftIndentDecreaseBtn" class="ui-button indentbtn" title="<?!=__('Left Indent decrease',locale)?>"><i class="material-icons md-18">format_indent_decrease</i></button>
          <button id="leftIndentIncreaseBtn" class="ui-button indentbtn" title="<?!=__('Left Indent increase',locale)?>"><i class="material-icons md-18">format_indent_increase</i></button>
          </span>
        </div>
        <div class="flexitem">
          <span id="paragraphalign" class="buttonset">
            <input type="radio" id="paragraphalign-left" value="<?!=BGET.ALIGN.LEFT?>" name="paragraphalign" <? if (userProperties.ParagraphStyles.PARAGRAPHALIGN==BGET.ALIGN.LEFT) { ?>CHECKED<? } ?>><label for="paragraphalign-left" title="<?!=__('ALIGN LEFT',locale)?>"><i class="material-icons md-18">format_align_left</i></label>
            <input type="radio" id="paragraphalign-center" value="<?!=BGET.ALIGN.CENTER?>" name="paragraphalign"<? if (userProperties.ParagraphStyles.PARAGRAPHALIGN==BGET.ALIGN.CENTER) { ?>CHECKED<? } ?>><label for="paragraphalign-center" title="<?!=__('ALIGN CENTER',locale)?>"><i class="material-icons md-18">format_align_center</i></label>
            <input type="radio" id="paragraphalign-right" value="<?!=BGET.ALIGN.RIGHT?>" name="paragraphalign"<? if (userProperties.ParagraphStyles.PARAGRAPHALIGN==BGET.ALIGN.RIGHT) { ?>CHECKED<? } ?>><label for="paragraphalign-right" title="<?!=__('ALIGN RIGHT',locale)?>"><i class="material-icons md-18">format_align_right</i></label>
            <input type="radio" id="paragraphalign-justify" value="<?!=BGET.ALIGN.JUSTIFY?>" name="paragraphalign"<? if (userProperties.ParagraphStyles.PARAGRAPHALIGN==BGET.ALIGN.JUSTIFY) { ?>CHECKED<? } ?>><label for="paragraphalign-justify" title="<?!=__('Justify',locale).toUpperCase()?>"><i class="material-icons md-18">format_align_justify</i></label>
          </span>          
        </div>
        <div class="flexitem bibleget-font-family">
          <select id="bibleget-font-family" class="bget-fontfamily-combobox" title="<?!=__('FONT',locale)?>"></select>
        </div>
        <div class="flexitem">
          <span id="lineheightBtn" class="ui-button" title="<?!=__('Lineheight',locale).toUpperCase()?>"><i class="material-icons md-18">format_line_spacing</i></span>
          <select id="lineheight-quote" class="selectmenu">
            <option value="1.0"<? if(userProperties.ParagraphStyles.LINEHEIGHT=="1.0"){ ?> SELECTED<? } ?>><?!=__('Single',locale)?> 1.0</option>
            <option value="1.15"<? if(userProperties.ParagraphStyles.LINEHEIGHT=="1.15"){ ?> SELECTED<? } ?>>1.15</option>
            <option value="1.5"<? if(userProperties.ParagraphStyles.LINEHEIGHT=="1.5"){ ?> SELECTED<? } ?>>1&#189;</option>
            <option value="2.0"<? if(userProperties.ParagraphStyles.LINEHEIGHT=="2.0"){ ?> SELECTED<? } ?>><?!=__('Double',locale)?> 2.0</option>
          </select>
        </div>
        <div class="flexitem">
          <span class="buttonset" title="<?!=__('Right Indent',locale)?>">
          <button id="rightIndentIncreaseBtn" class="ui-button indentbtn" title="<?!=__('Right Indent increase',locale)?>"><i class="material-icons md-18">format_indent_increase</i></button>
          <button id="rightIndentDecreaseBtn" class="ui-button indentbtn" title="<?!=__('Right Indent decrease',locale)?>"><i class="material-icons md-18">format_indent_decrease</i></button>
          </span>
        </div>
      </div>
            
      <h3><b><?!=__('Book / Chapter Format',locale)?></b></h3>
      <div class="toolbar ui-widget-header ui-corner-bottom">
        <div>
          <span id="bookchapterstyle" class="buttonset textstyles">
            <input type="checkbox" id="BookChapterStyles-<?!=BGET.TEXTSTYLE.BOLD?>" value="<?!=BGET.TEXTSTYLE.BOLD?>" name="BookChapterStyles-<?!=BGET.TEXTSTYLE.BOLD?>" <? if (userProperties.BookChapterStyles.BOLD) { ?>CHECKED<? } ?>><label for="BookChapterStyles-<?!=BGET.TEXTSTYLE.BOLD?>" title="<?!=__("BOLD",locale)?>"><b><span><?!=__("B",locale)?></span></b></label>
            <input type="checkbox" id="BookChapterStyles-<?!=BGET.TEXTSTYLE.ITALIC?>" value="<?!=BGET.TEXTSTYLE.ITALIC?>" name="BookChapterStyles-<?!=BGET.TEXTSTYLE.ITALIC?>" <? if (userProperties.BookChapterStyles.ITALIC) { ?>CHECKED<? } ?>><label for="BookChapterStyles-<?!=BGET.TEXTSTYLE.ITALIC?>" title="<?!=__("ITALIC",locale)?>"><b><i><span><?!=__("I",locale)?></span></i></b></label>
            <input type="checkbox" id="BookChapterStyles-<?!=BGET.TEXTSTYLE.UNDERLINE?>" value="<?!=BGET.TEXTSTYLE.UNDERLINE?>" name="BookChapterStyles-<?!=BGET.TEXTSTYLE.UNDERLINE?>" <? if (userProperties.BookChapterStyles.UNDERLINE) { ?>CHECKED<? } ?>><label for="BookChapterStyles-<?!=BGET.TEXTSTYLE.UNDERLINE?>" title="<?!=__("UNDERLINE",locale)?>"><b><u><span><?!=__("U",locale)?></span></u></b></label>
            <input type="checkbox" id="BookChapterStyles-<?!=BGET.TEXTSTYLE.STRIKETHROUGH?>" value="<?!=BGET.TEXTSTYLE.STRIKETHROUGH?>" name="BookChapterStyles-<?!=BGET.TEXTSTYLE.STRIKETHROUGH?>" <? if (userProperties.BookChapterStyles.STRIKETHROUGH) { ?>CHECKED<? } ?>><label for="BookChapterStyles-<?!=BGET.TEXTSTYLE.STRIKETHROUGH?>" title="<?!=__("STRIKETHROUGH",locale)?>"><b><del><span><?!=__("S",locale)?></span></del></b></label>
          </span>      
          <span id="BOOKCHAPTERVALIGN" class="buttonset">
            <input type="radio" id="bookchapter-normal" value="<?!=BGET.VALIGN.NORMAL?>" name="BOOKCHAPTERVALIGN" <? if (userProperties.BookChapterStyles.VALIGN==BGET.VALIGN.NORMAL) { ?>CHECKED<? } ?>><label for="bookchapter-normal" title="<?!=__("NORMAL",locale)?>"><span><b>X</b></span></label>
            <input type="radio" id="bookchapter-superscript" value="<?!=BGET.VALIGN.SUPERSCRIPT?>" name="BOOKCHAPTERVALIGN"<? if (userProperties.BookChapterStyles.VALIGN==BGET.VALIGN.SUPERSCRIPT) { ?>CHECKED<? } ?>><label for="bookchapter-superscript" title="<?!=__("SUPERSCRIPT",locale)?>"><span><b>X</b><b style="position: relative; top: -0.8em; font-size: 50%;">2</b></span></label>
            <input type="radio" id="bookchapter-subscript" value="<?!=BGET.VALIGN.SUBSCRIPT?>" name="BOOKCHAPTERVALIGN" <? if (userProperties.BookChapterStyles.VALIGN==BGET.VALIGN.SUBSCRIPT) { ?>CHECKED<? } ?>><label for="bookchapter-subscript" title="<?!=__("SUBSCRIPT",locale)?>"><span><b>X</b><b style="position: relative; top: 0.2em; font-size: 50%;">2</b></span></label>
          </span>
          <select id="bookchapter-fontsize" name="bookchapter-fontsize" class="fontsizes gapp-addon" title="<?!=__("FONT SIZE",locale)?>">
          <? var ops=[8,9,10,11,12,14,18,24,30,36,48,60,72,96]; 
             for(var i=0;i<ops.length;i++){ ?>
             <option value=<?!= ops[i] ?><? if(userProperties.BookChapterStyles.FONT_SIZE == ops[i]){ ?> SELECTED<? } ?>><?= ops[i] ?></option>
          <? } ?>
          </select>
          <input type="color" id="bookchapter-color" value="<?!= userProperties.BookChapterStyles.FOREGROUND_COLOR ?>" title="<?!=__("TEXT COLOR",locale)?>" />
          <input type="color" id="bookchapter-bgcolor" value="<?!= userProperties.BookChapterStyles.BACKGROUND_COLOR ?>" title="<?!=__("HIGHLIGHT COLOR",locale)?>" />
        </div>
      </div>    

      <h3><b><?!=__('Verse Number Format',locale)?></b></h3>
      <div class="toolbar ui-widget-header ui-corner-bottom">
        <div>
          <span id="versenumberstyle" class="buttonset textstyles">
            <input type="checkbox" id="VerseNumberStyles-<?!=BGET.TEXTSTYLE.BOLD?>" value="<?!=BGET.TEXTSTYLE.BOLD?>" name="VerseNumberStyles-<?!=BGET.TEXTSTYLE.BOLD?>" <? if(userProperties.VerseNumberStyles.BOLD){ ?>CHECKED<? } ?>><label for="VerseNumberStyles-<?!=BGET.TEXTSTYLE.BOLD?>" title="<?!=__("BOLD",locale)?>"><b><span><?!=__("B",locale)?></span></b></label>
            <input type="checkbox" id="VerseNumberStyles-<?!=BGET.TEXTSTYLE.ITALIC?>" value="<?!=BGET.TEXTSTYLE.ITALIC?>" name="VerseNumberStyles-<?!=BGET.TEXTSTYLE.ITALIC?>" <? if(userProperties.VerseNumberStyles.ITALIC){ ?>CHECKED<? } ?>><label for="VerseNumberStyles-<?!=BGET.TEXTSTYLE.ITALIC?>" title="<?!=__("ITALIC",locale)?>"><b><i><span><?!=__("I",locale)?></span></i></b></label>
            <input type="checkbox" id="VerseNumberStyles-<?!=BGET.TEXTSTYLE.UNDERLINE?>" value="<?!=BGET.TEXTSTYLE.UNDERLINE?>" name="VerseNumberStyles-<?!=BGET.TEXTSTYLE.UNDERLINE?>" <? if(userProperties.VerseNumberStyles.UNDERLINE){ ?>CHECKED<? } ?>><label for="VerseNumberStyles-<?!=BGET.TEXTSTYLE.UNDERLINE?>" title="<?!=__("UNDERLINE",locale)?>"><b><u><span><?!=__("U",locale)?></span></u></b></label>
            <input type="checkbox" id="VerseNumberStyles-<?!=BGET.TEXTSTYLE.STRIKETHROUGH?>" value="<?!=BGET.TEXTSTYLE.STRIKETHROUGH?>" name="VerseNumberStyles-<?!=BGET.TEXTSTYLE.STRIKETHROUGH?>" <? if (userProperties.VerseNumberStyles.STRIKETHROUGH) { ?>CHECKED<? } ?>><label for="VerseNumberStyles-<?!=BGET.TEXTSTYLE.STRIKETHROUGH?>" title="<?!=__("STRIKETHROUGH",locale)?>"><b><del><span><?!=__("S",locale)?></span></del></b></label>
          </span>
          <span id="VERSENUMBERVALIGN" class="buttonset">
            <input type="radio" id="versenumber-normal" value="<?!=BGET.VALIGN.NORMAL?>" name="VERSENUMBERVALIGN" <? if(userProperties.VerseNumberStyles.VALIGN==BGET.VALIGN.NORMAL){ ?>CHECKED<? } ?>><label for="versenumber-normal" title="<?!=__("NORMAL",locale)?>"><span><b>X</b></span></label>
            <input type="radio" id="versenumber-superscript" value="<?!=BGET.VALIGN.SUPERSCRIPT?>" name="VERSENUMBERVALIGN"  <? if(userProperties.VerseNumberStyles.VALIGN==BGET.VALIGN.SUPERSCRIPT){ ?>CHECKED<? } ?>><label for="versenumber-superscript" title="<?!=__("SUPERSCRIPT",locale)?>"><span><b>X</b><b style="position: relative; top: -0.8em; font-size: 50%;">2</b></span></label>
            <input type="radio" id="versenumber-subscript" value="<?!=BGET.VALIGN.SUBSCRIPT?>" name="VERSENUMBERVALIGN" <? if(userProperties.VerseNumberStyles.VALIGN==BGET.VALIGN.SUBSCRIPT){ ?>CHECKED<? } ?>><label for="versenumber-subscript" title="<?!=__("SUBSCRIPT",locale)?>"><span><b>X</b><b style="position: relative; top: 0.2em; font-size: 50%;">2</b></span></label>
          </span>
          <select id="versenumber-fontsize" name="versenumber-fontsize" class="fontsizes gapp-addon" title="<?!=__("FONT SIZE",locale)?>">
          <? var ops=[8,9,10,11,12,14,18,24,30,36,48,60,72,96]; 
             for(var i=0;i<ops.length;i++){ ?>
             <option value=<?= ops[i] ?><? if(userProperties.VerseNumberStyles.FONT_SIZE == ops[i]){ ?> SELECTED<? } ?>><?= ops[i] ?></option>
          <? } ?>
          </select>
          <input type="color" id="versenumber-color" value="<?!= userProperties.VerseNumberStyles.FOREGROUND_COLOR ?>" title="<?!=__("TEXT COLOR",locale)?>" />
          <input type="color" id="versenumber-bgcolor" value="<?!= userProperties.VerseNumberStyles.BACKGROUND_COLOR ?>" title="<?!=__("HIGHLIGHT COLOR",locale)?>" />
        </div>
      </div>    

      <h3><b><?!=__('Verse Text Format',locale)?></b></h3>
      <div class="toolbar ui-widget-header ui-corner-bottom">
        <div>
          <span id="versetextstyle" class="buttonset textstyles">
            <input type="checkbox" id="VerseTextStyles-<?!=BGET.TEXTSTYLE.BOLD?>" value="<?!=BGET.TEXTSTYLE.BOLD?>" name="VerseTextStyles-<?!=BGET.TEXTSTYLE.BOLD?>" <? if(userProperties.VerseTextStyles.BOLD){ ?>CHECKED<? } ?>><label for="VerseTextStyles-<?!=BGET.TEXTSTYLE.BOLD?>" title="<?!=__("BOLD",locale)?>"><b><span><?!=__("B",locale)?></span></b></label>
            <input type="checkbox" id="VerseTextStyles-<?!=BGET.TEXTSTYLE.ITALIC?>" value="<?!=BGET.TEXTSTYLE.ITALIC?>" name="VerseTextStyles-<?!=BGET.TEXTSTYLE.ITALIC?>" <? if(userProperties.VerseTextStyles.ITALIC){ ?>CHECKED<? } ?>><label for="VerseTextStyles-<?!=BGET.TEXTSTYLE.ITALIC?>" title="<?!=__("ITALIC",locale)?>"><b><i><span><?!=__("I",locale)?></span></i></b></label>
            <input type="checkbox" id="VerseTextStyles-<?!=BGET.TEXTSTYLE.UNDERLINE?>" value="<?!=BGET.TEXTSTYLE.UNDERLINE?>" name="VerseTextStyles-<?!=BGET.TEXTSTYLE.UNDERLINE?>" <? if(userProperties.VerseTextStyles.UNDERLINE){ ?>CHECKED<? } ?>><label for="VerseTextStyles-<?!=BGET.TEXTSTYLE.UNDERLINE?>" title="<?!=__("UNDERLINE",locale)?>"><b><u><span><?!=__("U",locale)?></span></u></b></label>
            <input type="checkbox" id="VerseTextStyles-<?!=BGET.TEXTSTYLE.STRIKETHROUGH?>" value="<?!=BGET.TEXTSTYLE.STRIKETHROUGH?>" name="VerseTextStyles-<?!=BGET.TEXTSTYLE.STRIKETHROUGH?>" <? if (userProperties.VerseTextStyles.STRIKETHROUGH) { ?>CHECKED<? } ?>><label for="VerseTextStyles-<?!=BGET.TEXTSTYLE.STRIKETHROUGH?>" title="<?!=__("STRIKETHROUGH",locale)?>"><b><del><span><?!=__("S",locale)?></span></del></b></label>
          </span>      
          <span id="VERSETEXTVALIGN" class="buttonset">
            <input type="radio" id="versetext-normal" name="VERSETEXTVALIGN" value="<?!=BGET.VALIGN.NORMAL?>" <? if(userProperties.VerseTextStyles.VALIGN == BGET.VALIGN.NORMAL){ ?>CHECKED<? } ?>><label for="versetext-normal" title="<?!=__("NORMAL",locale)?>"><span><b>X</b></span></label>
            <input type="radio" id="versetext-superscript" name="VERSETEXTVALIGN" value="<?!=BGET.VALIGN.SUPERSCRIPT?>" <? if(userProperties.VerseTextStyles.VALIGN == BGET.VALIGN.SUPERSCRIPT){ ?>CHECKED<? } ?>><label for="versetext-superscript" title="<?!=__("SUPERSCRIPT",locale)?>"><span><b>X</b><b style="position: relative; top: -0.8em; font-size: 50%;">2</b></span></label>
            <input type="radio" id="versetext-subscript" name="VERSETEXTVALIGN" value="<?!=BGET.VALIGN.SUBSCRIPT?>" <? if(userProperties.VerseTextStyles.VALIGN == BGET.VALIGN.SUBSCRIPT){ ?>CHECKED<? } ?>><label for="versetext-subscript" title="<?!=__("SUBSCRIPT",locale)?>"><span><b>X</b><b style="position: relative; top: 0.2em; font-size: 50%;">2</b></span></label>
          </span>
          <select id="versetext-fontsize" name="versetext-fontsize" class="fontsizes gapp-addon" title="<?!=__("FONT SIZE",locale)?>">
            <? var ops=[8,9,10,11,12,14,18,24,30,36,48,60,72,96]; 
            for(var i=0;i<ops.length;i++){ ?>
            <option value=<?!= ops[i] ?><? if(userProperties.VerseTextStyles.FONT_SIZE == ops[i]){ ?> SELECTED<? } ?>><?= ops[i] ?></option>
            <? } ?>
          </select>
          <input type="color" id="versetext-color" value="<?!= userProperties.VerseTextStyles.FOREGROUND_COLOR ?>" title="<?!=__("TEXT COLOR",locale)?>" />
          <input type="color" id="versetext-bgcolor" value="<?!= userProperties.VerseTextStyles.BACKGROUND_COLOR ?>" title="<?!=__("HIGHLIGHT COLOR",locale)?>" />
        </div>
      </div> <!-- END TOOLBAR WIDGET -->    
    </div> <!-- END ACCORDION  -->
    <?!= PreviewBox ?>
    <div class="flexcontainer" id="otherSettingsTab1">
      <div class="flexitem">
        <label title="<?!=__("p9",locale)?>"><input type="checkbox" id="NOVERSIONFORMATTING" name="NOVERSIONFORMATTING" <? if(userProperties.ParagraphStyles.NOVERSIONFORMATTING){ ?>CHECKED<? } ?>><?!=__("lbl1",locale)?></label>
      </div>
      <div class="flexitem">
        <label><input type="checkbox" id="INTERFACEINCM" name="INTERFACEINCM" <? if(userProperties.ParagraphStyles.INTERFACEINCM){ ?>CHECKED<? } ?>><?!=__("DocInterfaceInCM",locale)?></label>
      </div>
    </div>
  </div>  
  <!-- END TAB 1-->
  <!-- BEGIN TAB 2-->
  <div id="tab2">
<!--
        SHOWBIBLEVERSION: BGET.VISIBILITY.SHOW,
        BIBLEVERSIONALIGNMENT: BGET.ALIGN.LEFT,
        BIBLEVERSIONPOSITION: BGET.POS.TOP,
        BIBLEVERSIONWRAP: BGET.WRAP.NONE,
        BOOKCHAPTERPOSITION: BGET.POS.INLINE,
        BOOKCHAPTERALIGNMENT: BGET.ALIGN.LEFT,
        BOOKCHAPTERWRAP: BGET.WRAP.NONE
        SHOWVERSENUMBERS: BGET.VISIBILITY.SHOW,
-->
    <div class="flexcontainerX">
    
    <div class="flexcontainerV">
      <div class="centered"><?!=__('Bible version',locale)?></div>
      <div class="flexcontainerB">
    
        <div class="flexitemB">
          <span class="ctrlGrpLbl"><?!=__('Visibility',locale)?></span><br />
          <span id="SHOWBIBLEVERSION" class="buttonset">
            <label><input type="radio" name="SHOWBIBLEVERSION" value="<?!=BGET.VISIBILITY.SHOW?>" <? if(userProperties.LayoutPrefs.SHOWBIBLEVERSION == BGET.VISIBILITY.SHOW){ ?>CHECKED<? } ?> /><?!=__('Show',locale)?></label>
            <label><input type="radio" name="SHOWBIBLEVERSION" value="<?!=BGET.VISIBILITY.HIDE?>" <? if(userProperties.LayoutPrefs.SHOWBIBLEVERSION == BGET.VISIBILITY.HIDE){ ?>CHECKED<? } ?> /><?!=__('Hide',locale)?></label>
          </span>
        </div>
    
        <div class="flexitemB">
          <span class="ctrlGrpLbl"><?!=__('Wrap',locale)?></span><br />
          <span id="BIBLEVERSIONWRAP" class="buttonset">
            <label><input type="radio" name="BIBLEVERSIONWRAP" value="<?!=BGET.WRAP.NONE?>" <? if(userProperties.LayoutPrefs.BIBLEVERSIONWRAP == BGET.WRAP.NONE){ ?>CHECKED<? } ?> /><?!=__('None',locale)?></label>
            <label><input type="radio" name="BIBLEVERSIONWRAP" value="<?!=BGET.WRAP.PARENTHESES?>" <? if(userProperties.LayoutPrefs.BIBLEVERSIONWRAP == BGET.WRAP.PARENTHESES){ ?>CHECKED<? } ?> /><?!=__('Parentheses',locale)?></label>
            <label><input type="radio" name="BIBLEVERSIONWRAP" value="<?!=BGET.WRAP.BRACKETS?>" <? if(userProperties.LayoutPrefs.BIBLEVERSIONWRAP == BGET.WRAP.BRACKETS){ ?>CHECKED<? } ?> /><?!=__('Brackets',locale)?></label>
          </span>
        </div>
    
        <div class="flexitemB">
          <span class="ctrlGrpLbl"><?!=__('Alignment',locale)?></span><br />
          <span id="BIBLEVERSIONALIGNMENT" class="buttonset">
            <label><input type="radio" name="BIBLEVERSIONALIGNMENT" value="<?!=BGET.ALIGN.LEFT?>" <? if(userProperties.LayoutPrefs.BIBLEVERSIONALIGNMENT == BGET.ALIGN.LEFT){ ?>CHECKED<? } ?> /><?!=__('Left',locale)?></label>
            <label><input type="radio" name="BIBLEVERSIONALIGNMENT" value="<?!=BGET.ALIGN.CENTER?>" <? if(userProperties.LayoutPrefs.BIBLEVERSIONALIGNMENT == BGET.ALIGN.CENTER){ ?>CHECKED<? } ?> /><?!=__('Center',locale)?></label>
            <label><input type="radio" name="BIBLEVERSIONALIGNMENT" value="<?!=BGET.ALIGN.RIGHT?>" <? if(userProperties.LayoutPrefs.BIBLEVERSIONALIGNMENT == BGET.ALIGN.RIGHT){ ?>CHECKED<? } ?> /><?!=__('Right',locale)?></label>
          </span>
        </div>

        <div class="flexitemB">
          <span class="ctrlGrpLbl"><?!=__('Positioning',locale)?></span><br />
          <span id="BIBLEVERSIONPOSITION" class="buttonset">
            <label><input type="radio" name="BIBLEVERSIONPOSITION" value="<?!=BGET.POS.TOP?>" <? if(userProperties.LayoutPrefs.BIBLEVERSIONPOSITION == BGET.POS.TOP){ ?>CHECKED<? } ?> /><?!=__('Top',locale)?></label>
            <label><input type="radio" name="BIBLEVERSIONPOSITION" value="<?!=BGET.POS.BOTTOM?>" <? if(userProperties.LayoutPrefs.BIBLEVERSIONPOSITION == BGET.POS.BOTTOM){ ?>CHECKED<? } ?> /><?!=__('Bottom',locale)?></label>
          </span>
        </div>
    
      </div><!-- flexcontainerB END -->
      
    </div><!-- flexcontainerV END-->
    
    <div class="flexcontainerV">
      <div class="centered"><?!=__('Book and Chapter',locale)?></div>
      <div class="flexcontainerB">    
    
        <div class="flexitemB">
          <span class="ctrlGrpLbl"><?!=__('Format',locale)?></span><br />
          <span id="BOOKCHAPTERFORMAT" class="buttonset">
            <label><input type="radio" name="BOOKCHAPTERFORMAT" value="<?!=BGET.FORMAT.BIBLELANG?>" <? if(userProperties.LayoutPrefs.BOOKCHAPTERFORMAT == BGET.FORMAT.BIBLELANG){ ?>CHECKED<? } ?> /><?!=__('BIBLELANG',locale)?></label>
            <label><input type="radio" name="BOOKCHAPTERFORMAT" value="<?!=BGET.FORMAT.BIBLELANGABBREV?>" <? if(userProperties.LayoutPrefs.BOOKCHAPTERFORMAT == BGET.FORMAT.BIBLELANGABBREV){ ?>CHECKED<? } ?> /><?!=__('BIBLELANGABBREV',locale)?></label>
            <label><input type="radio" name="BOOKCHAPTERFORMAT" value="<?!=BGET.FORMAT.USERLANG?>" <? if(userProperties.LayoutPrefs.BOOKCHAPTERFORMAT == BGET.FORMAT.USERLANG){ ?>CHECKED<? } ?> /><?!=__('USERLANG',locale)?></label>
            <label><input type="radio" name="BOOKCHAPTERFORMAT" value="<?!=BGET.FORMAT.USERLANGABBREV?>" <? if(userProperties.LayoutPrefs.BOOKCHAPTERFORMAT == BGET.FORMAT.USERLANGABBREV){ ?>CHECKED<? } ?> /><?!=__('USERLANGABBREV',locale)?></label>
          </span>
          <label><input type="checkbox" id="BOOKCHAPTERFULLQUERY" name="BOOKCHAPTERFULLQUERY" <? if(userProperties.LayoutPrefs.BOOKCHAPTERFULLQUERY){ ?>CHECKED<? } ?> /><?!=__('Show full reference',locale)?></label>
        </div>    
    
        <div class="flexitemB">
          <span class="ctrlGrpLbl"><?!=__('Wrap',locale)?></span><br />
          <span id="BOOKCHAPTERWRAP" class="buttonset">
            <label><input type="radio" name="BOOKCHAPTERWRAP" value="<?!=BGET.WRAP.NONE?>" <? if(userProperties.LayoutPrefs.BOOKCHAPTERWRAP == BGET.WRAP.NONE){ ?>CHECKED<? } ?> /><?!=__('None',locale)?></label>
            <label><input type="radio" name="BOOKCHAPTERWRAP" value="<?!=BGET.WRAP.PARENTHESES?>" <? if(userProperties.LayoutPrefs.BOOKCHAPTERWRAP == BGET.WRAP.PARENTHESES){ ?>CHECKED<? } ?> /><?!=__('Parentheses',locale)?></label>
            <label><input type="radio" name="BOOKCHAPTERWRAP" value="<?!=BGET.WRAP.BRACKETS?>" <? if(userProperties.LayoutPrefs.BOOKCHAPTERWRAP == BGET.WRAP.BRACKETS){ ?>CHECKED<? } ?> /><?!=__('Brackets',locale)?></label>
          </span>
        </div>
    
        <div class="flexitemB">
          <span class="ctrlGrpLbl"><?!=__('Alignment',locale)?></span><br />
          <span id="BOOKCHAPTERALIGNMENT" class="buttonset">
            <label><input type="radio" name="BOOKCHAPTERALIGNMENT" value="<?!=BGET.ALIGN.LEFT?>" <? if(userProperties.LayoutPrefs.BOOKCHAPTERALIGNMENT == BGET.ALIGN.LEFT){ ?>CHECKED<? } ?> /><?!=__('Left',locale)?></label>
            <label><input type="radio" name="BOOKCHAPTERALIGNMENT" value="<?!=BGET.ALIGN.CENTER?>" <? if(userProperties.LayoutPrefs.BOOKCHAPTERALIGNMENT == BGET.ALIGN.CENTER){ ?>CHECKED<? } ?> /><?!=__('Center',locale)?></label>
            <label><input type="radio" name="BOOKCHAPTERALIGNMENT" value="<?!=BGET.ALIGN.RIGHT?>" <? if(userProperties.LayoutPrefs.BOOKCHAPTERALIGNMENT == BGET.ALIGN.RIGHT){ ?>CHECKED<? } ?> /><?!=__('Right',locale)?></label>
          </span>
        </div>
      
        <div class="flexitemB">
          <span class="ctrlGrpLbl"><?!=__('Positioning',locale)?></span><br />
          <span id="BOOKCHAPTERPOSITION" class="buttonset">
            <label><input type="radio" name="BOOKCHAPTERPOSITION" value="<?!=BGET.POS.TOP?>" <? if(userProperties.LayoutPrefs.BOOKCHAPTERPOSITION == BGET.POS.TOP){ ?>CHECKED<? } ?> /><?!=__('Top',locale)?></label>
            <label><input type="radio" name="BOOKCHAPTERPOSITION" value="<?!=BGET.POS.BOTTOM?>" <? if(userProperties.LayoutPrefs.BOOKCHAPTERPOSITION == BGET.POS.BOTTOM){ ?>CHECKED<? } ?> /><?!=__('Bottom',locale)?></label>
            <label><input type="radio" name="BOOKCHAPTERPOSITION" value="<?!=BGET.POS.BOTTOMINLINE?>" <? if(userProperties.LayoutPrefs.BOOKCHAPTERPOSITION == BGET.POS.BOTTOMINLINE){ ?>CHECKED<? } ?> /><?!=__('Bottom Inline',locale)?></label>
          </span>
        </div>
    
      </div><!-- flexcontainerB END -->
    </div><!-- flexcontainerV END -->
        
    <div class="flexcontainerV">
      <div class="centered"><?!=__('Verse number',locale)?></div>
      <div class="flexcontainerB">
    
        <div class="flexitemB">
          <span class="ctrlGrpLbl"><?!=__('Visibility',locale)?></span><br />
          <span id="SHOWVERSENUMBERS" class="buttonset">
            <label><input type="radio" name="SHOWVERSENUMBERS" value="<?!=BGET.VISIBILITY.SHOW?>" <? if(userProperties.LayoutPrefs.SHOWVERSENUMBERS == BGET.VISIBILITY.SHOW){ ?>CHECKED<? } ?> /><?!=__('Show',locale)?></label>
            <label><input type="radio" name="SHOWVERSENUMBERS" value="<?!=BGET.VISIBILITY.HIDE?>" <? if(userProperties.LayoutPrefs.SHOWVERSENUMBERS == BGET.VISIBILITY.HIDE){ ?>CHECKED<? } ?> /><?!=__('Hide',locale)?></label>
          </span>
        </div>
    
      </div><!-- flexcontainerB END -->
    </div><!-- flexcontainerV END -->
    
    </div><!-- flexContainerX END -->
    <?!= PreviewBox ?>
    <? if(CURRENTSTATE==ADDONSTATE.DEVELOPMENT){ ?>
    <fieldset style="font-size:.5em;">
      <legend>Debug: userProps and updateUserProps</legend>
      <div style="display:flex;flex-direction: row;justify-content: space-between;">
      <div>
        <p><b>userPropsFromServer</b></p>
        <ol id="userPropsFromServer">
        </ol>
      </div>
      <div>
        <p><b>userPropsAfterUpdate</b></p>
        <ol id="userPropsAfterUpdate">
        </ol>
      </div>
      <div>
        <p><b>userPropsClientJSAfterUpdate</b></p>
        <ol id="userPropsClientJSAfterUpdate">
        </ol>
      </div>
      </div>
    </fieldset>
    <? } ?>
  </div>
  <!-- END TAB 2-->
  
  <div id="tab3">
    <p style="text-align:justify;"><?=__('p7A',locale)?> <span style="color:Blue;"><?=languages.length?></span> <?=__('p7B',locale)?> <br />
      <? for(var i in languages){ 
      if(i==0){?><i style="color:Blue;"><?=_l(languages[i],locale)?></i><?}
      else{?>, <i style="color:Blue;"><?=_l(languages[i],locale)?></i><?}
      }?>
    </p>
    <p><span style="color:Blue;"><?=Object.keys(versions).length?></span> <?=__('p8',locale)?></p>
    <div id="tableContainer" class="tableContainer">
      <table border="0" cellpadding="0" cellspacing="0" width="100%" class="scrollTable">
        <thead class="fixedHeader">
          <tr class="alternateRow"><th><a href="#"><?=toProperCase(__('ABBREVIATION',locale))?></a></th><th><a href="#"><?=__('Full Name',locale)?></a></th><th><a href="#"><?=__('Year',locale)?></a></th></tr>
        </thead>
        <tbody class="scrollContent">
        <?var info = []; var x=0; for(var i in versions){ info = versions[i].split("|"); ?>
          <tr class="<?=x%2==0?"normalRow":"alternateRow"?>"><td><?=i?></td><td><?=info[0]?></td><td><?=info[1]?></td></tr>
        <?x++;}?>
        </tbody>
      </table>
    </div>        
    <div style="clear:both;text-align:center;margin-top:16px;"><button class="button" id="updatedata"><?=__('UPDATE DATA FROM BIBLEGET SERVER',locale)?></button></div>
    <hr style="margin-top:16px;" />
    <div style="text-align:center;margin-top:16px;"><button class="button" id="RESET_DEFAULT_USERPROPS"><?=__('RESET PREFERENCES TO DEFAULT OPTIONS',locale)?></button></div>
  </div>
  <!-- END TAB 3-->

</div>
<!-- -->
<?
  if(CURRENTSTATE == ADDONSTATE.DEVELOPMENT){
    consoleLog('body html complete, now preparing scripts in footer of document in Settings.html');
  }   
?>

<?!= include("FontListAutocomplete"); ?>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.0/jquery-ui.min.js"></script>
<?!= include("FontListCombobox"); ?>

<script type="text/javascript">
const dPR = window.devicePixelRatio;
//const ptToPx = (96 * dPR) / 72;//1.33 * dPR;
//this will be our global variable that holds the user preferences, which should be a pure JSON obj without stringified values (nostringify=true)
var userProps = {populated:false},
  domopscomplete = false,
  bkChptr1Sam213 = '',
  bkChptrPs11412 = '';
  
switch('<?!=userProperties.LayoutPrefs.BOOKCHAPTERFORMAT?>'){
  case '<?!=BGET.FORMAT.BIBLELANG?>':
    bkChptr1Sam213 = "I Samuelis 2";
    bkChptrPs11412 = "Psalmorum 114";
    break;
  case '<?!=BGET.FORMAT.BIBLELANGABBREV?>':
    bkChptr1Sam213 = "ISam 2";
    bkChptrPs11412 = "Ps 114";
    break;
  case '<?!=BGET.FORMAT.USERLANG?>': 
    bkChptr1Sam213 = '<?!=__('ISamuelis2',locale)?>';
    bkChptrPs11412 = '<?!=__('Psalmorum114',locale)?>';
    break;
  case '<?!=BGET.FORMAT.USERLANGABBREV?>':
    bkChptr1Sam213 = '<?!=__('ISam2',locale)?>';
    bkChptrPs11412 = '<?!=__('Ps114',locale)?>';
    break;
}
/*
Number.prototype.map = function (in_min, in_max, out_min, out_max) {
  return (this - in_min) * (out_max - out_min) / (in_max - in_min) + out_min;
}
*/
//We can't save the userProps obj unless we have all the user Properties in this object, this is why we need the object,
//and need it fully populated, not only available to populate one at a time
var passUserPropertiesServer2Client = function(propsobj){ 
    userProps = propsobj;
    userProps.populated = true;
    <? if(CURRENTSTATE==ADDONSTATE.DEVELOPMENT){ ?>
    for (let [key, value] of Object.entries(propsobj).sort() ) {
      if(typeof value === 'object'){
        let $li = jQuery('<li>',{text: key});
        let $ol = jQuery('<ol>');
        for(let [keyB, valueB] of Object.entries(value).sort()){
          $ol.append('<li>'+keyB+' : '+valueB+'</li>')
        }
        jQuery($li).append($ol);
        jQuery('#userPropsFromServer').append($li);
      }
      else{
        jQuery('#userPropsFromServer').append('<li>'+key+' : '+value+'</li>');
      }
    }
    <? } ?>
    
    //spinner will disappear only when both jquery's dom manipulations are complete
    //and userprops are loaded from the server
    if(domopscomplete){ 
      $('.spinner').fadeOut("fast"); 
      // $('#tab1').append('<p>spinner was faded after properties populated</p>');
      // ^^^ THIS IS ALWAYS THE CASE, PROPERTIES UPDATE TAKES LONGER THAN JQUERY DOM MANIPULATION ^^^ //
    }
}

var saveUserProps = function(userprops){
  $('.spinner').fadeIn("fast");
  delete userProps.populated;
  google.script.run.withSuccessHandler(userPropsUpdateSuccess).setUserProperties(userprops);
},
makeUnique = function(str) {
  return String.prototype.concat(...new Set(str));
},
/* requires float, returns int */
inchesToPoints = function(inchVal){
  if(typeof inchVal !== 'float'){
    inchVal = parseFloat(inchVal);
  }
  return Math.round(inchVal * 72);
},
/* requires float, returns int */
centimetersToPoints = function (cmVal){
  if(typeof cmVal !== 'float'){
    cmVal = parseFloat(cmVal);
  }
  return Math.round(cmVal * 28.3464567);
},
userPropsUpdateSuccess = function(updatedProps){
  //redefine userProps.populated which we deleted upon saving userProps,
  //to avoid it being saved to Apps Script UserProperties
  userProps.populated = true;
  <? if(CURRENTSTATE==ADDONSTATE.DEVELOPMENT){ ?>
  jQuery('#userPropsAfterUpdate').empty();
  //updatedProps will have stringified values
  for (let [key, value] of Object.entries(updatedProps).sort()) {
    if(typeof value === 'string'){
      value = JSON.parse(value);
    }
    if(typeof value === 'object'){
      let $li = jQuery('<li>',{text: key});
      let $ol = jQuery('<ol>');
      for(let [keyB, valueB] of Object.entries(value).sort()){
        $ol.append('<li>'+keyB+' : '+valueB+'</li>')
      }
      jQuery($li).append($ol);
      jQuery('#userPropsAfterUpdate').append($li);
    }
    else{
      jQuery('#userPropsAfterUpdate').append('<li>'+key+' : '+value+'</li>');
    }
  }
  //now let's compare userProps with updatedPropsUnstringified, they should be the same!
  jQuery('#userPropsClientJSAfterUpdate').empty();
  for (let [key, value] of Object.entries(userProps).sort()) {
    if(typeof value === 'object'){
      let $li = jQuery('<li>',{text: key});
      let $ol = jQuery('<ol>');
      for(let [keyB, valueB] of Object.entries(value).sort()){
        $ol.append('<li>'+keyB+' : '+valueB+'</li>')
      }
      jQuery($li).append($ol);
      jQuery('#userPropsClientJSAfterUpdate').append($li);
    }
    else{
      jQuery('#userPropsClientJSAfterUpdate').append('<li>'+key+' : '+value+'</li>');
    }
  }
  <? } ?>
  $('.spinner').fadeOut("fast");
},
getPixelRatioVals = function(rulerLength,convertToCM){
  let inchesToCM = 2.54,
    dpr = window.devicePixelRatio,
    //ppi = ((96 * dpr) / 100),
    //dpi = (96 * ppi),
    dpi = 96 * dpr,
    drawInterval = 0.125;
  if(convertToCM){
    //ppi /= inchesToCM;
    dpi /= inchesToCM;
    rulerLength *= inchesToCM;
    drawInterval = 0.25;
  }
  return {
    inchesToCM: inchesToCM,
    dpr: dpr,      
    //ppi: ppi,
    dpi: dpi,
    rulerLength: rulerLength,
    drawInterval: drawInterval
  };
},
triangleAt = function (x,context,pixelRatioVals,initialPadding,canvasWidth){
  let xPos = x*pixelRatioVals.dpi;//x.map(0,pixelRatioVals.rulerLength,0,(canvasWidth-(initialPadding*2)));
  window.xVal = x;
  window.xPos = xPos;
  context.lineWidth = 0.5;
  context.fillStyle = "#4285F4";
  context.beginPath();
  context.moveTo(initialPadding+xPos-6,11);
  context.lineTo(initialPadding+xPos+6,11);
  context.lineTo(initialPadding+xPos,18);
  context.closePath();
  context.stroke();
  context.fill();
},
/**
 * FUNCTION drawRuler
 * @ rulerLen (float) in Inches (e.g. 6.25)
 * @ cvtToCM (boolean) whether to convert values from inches to centimeters
 * @ lftindnt (float) in Inches, to set xPos of triangle for left indent
 * @ rgtindnt (float) in Inches, to set xPos of triangle for right indent
*/
drawRuler = function(rulerLen, cvtToCM, lftindnt, rgtindnt){
  var pixelRatioVals = getPixelRatioVals(rulerLen,cvtToCM),
      initialPadding = 35,
      $canvas = jQuery('.previewRuler');
  $canvas.each(function(){
    let canvas = this,
        context = canvas.getContext('2d'),
        canvasWidth = (rulerLen * 96 * pixelRatioVals.dpr) + (initialPadding*2);
    canvas.style.width = canvasWidth + 'px';
    canvas.style.height = '20px';
    canvas.width = Math.round(canvasWidth * pixelRatioVals.dpr);
    canvas.height = Math.round(20 * pixelRatioVals.dpr);
    canvas.style.width = Math.round(canvas.width / pixelRatioVals.dpr) + 'px';
    canvas.style.height = Math.round(canvas.height / pixelRatioVals.dpr) + 'px';

    context.scale(pixelRatioVals.dpr,pixelRatioVals.dpr);
    context.translate(pixelRatioVals.dpr, 0);
      
    context.lineWidth = 0.5;
    context.strokeStyle = '#000';
    context.font = 'bold 10px Arial';

    context.beginPath();
    context.moveTo(initialPadding, 1);
    context.lineTo(initialPadding + (pixelRatioVals.rulerLength * pixelRatioVals.dpi),1);
    context.stroke();

    let currentWholeNumber = 0;
    let offset = 2;

    for(let interval = 0; interval <= pixelRatioVals.rulerLength; interval += pixelRatioVals.drawInterval){
      let xPosA = Math.round(interval*pixelRatioVals.dpi)+0.5;
    
      if(interval == Math.floor(interval) && interval > 0){
        if(currentWholeNumber+1 == 10){ offset+=4; }
        context.fillText(++currentWholeNumber,initialPadding+xPosA-offset,14);
      }
      else if(interval == Math.floor(interval)+0.5){
        context.beginPath();
        context.moveTo(initialPadding+xPosA,15);
        context.lineTo(initialPadding+xPosA,5); 
        context.closePath();
        context.stroke();   
      }
      else{
        context.beginPath();
        context.moveTo(initialPadding+xPosA,10);
        context.lineTo(initialPadding+xPosA,5);
        context.closePath();
        context.stroke();
      }
    }
  
    triangleAt(lftindnt,context,pixelRatioVals,initialPadding,canvasWidth);
    triangleAt(pixelRatioVals.rulerLength-rgtindnt,context,pixelRatioVals,initialPadding,canvasWidth);
    context.translate(-pixelRatioVals.dpr, -0);

  });
  
};


//Start our page manipulation and event handling
jQuery(document).ready(function(){
    google.script.run.withFailureHandler(failedAcctTest).withSuccessHandler(successAcctTest).getEffectiveUserEM();
    //we will try to get a pure JSON obj, so we don't need to parse every value
    google.script.run.withSuccessHandler(passUserPropertiesServer2Client).getUserProperties(true); 
    
    //render interface with jquery ui and set events for ui
    jQuery('#accordion').accordion({heightStyle: "content"});
    jQuery('#tabs').tabs({
      active: $('#activetab').val()
    });
    
    $('ul.nav li').click(function(){
      var divid = $(this).data("divid");
      
      $('div.active-tab').fadeOut('slow','swing',function(){
        $(this).addClass('inactive-tab');
        $('div#'+divid).addClass('active-tab').fadeIn('slow','swing');
      });
      $('ul.nav li').removeClass('active');
      $(this).addClass('active');
    });
    
    /*******************************************************
     *                     TAB 1                           *
     ******************************************************/
    jQuery('#tab1 .buttonset').controlgroup();


    /*********** GENERAL PARAGRAPH STYLE SETTINGS *********
     ***********  userProperties.ParagraphStyles  *********
     *****************************************************/
     
    $('.indentbtn').on('click',function(){
      let thisid = $(this).attr("id");
      switch(thisid){
        case 'leftIndentIncreaseBtn':
          if(userProps.ParagraphStyles.LEFTINDENT < 2.5){
            userProps.ParagraphStyles.INTERFACEINCM ? userProps.ParagraphStyles.LEFTINDENT += .5 : userProps.ParagraphStyles.LEFTINDENT += .25;
          }
          break;
        case 'leftIndentDecreaseBtn':
          if(userProps.ParagraphStyles.LEFTINDENT > 0){
            userProps.ParagraphStyles.INTERFACEINCM ? userProps.ParagraphStyles.LEFTINDENT -= .5 : userProps.ParagraphStyles.LEFTINDENT -= .25;
          }
          break;
        case 'rightIndentIncreaseBtn':
          if(userProps.ParagraphStyles.RIGHTINDENT < 2.5){
            userProps.ParagraphStyles.INTERFACEINCM ? userProps.ParagraphStyles.RIGHTINDENT += .5 : userProps.ParagraphStyles.RIGHTINDENT += .25;
          }
          break;
        case 'rightIndentDecreaseBtn':
          if(userProps.ParagraphStyles.RIGHTINDENT > 0){
            userProps.ParagraphStyles.INTERFACEINCM ? userProps.ParagraphStyles.RIGHTINDENT -= .5 : userProps.ParagraphStyles.RIGHTINDENT -= .25;
          }
          break;
      }
      //leftindent = (userProps.ParagraphStyles.INTERFACEINCM ? centimetersToPoints(userProps.ParagraphStyles.LEFTINDENT) : inchesToPoints(userProps.ParagraphStyles.LEFTINDENT)) * ptToPx;   //convert to point size then to pixel size useful for CSS margin-left property
      //rightindent = (userProps.ParagraphStyles.INTERFACEINCM ? centimetersToPoints(userProps.ParagraphStyles.RIGHTINDENT) : inchesToPoints(userProps.ParagraphStyles.RIGHTINDENT)) * ptToPx; //convert to point size then to pixel size useful for CSS margin-right property
      let pixelRatioVals = getPixelRatioVals(6.25,userProps.ParagraphStyles.INTERFACEINCM);
      let leftindent = userProps.ParagraphStyles.LEFTINDENT * pixelRatioVals.dpi + 35;
      let rightindent = userProps.ParagraphStyles.RIGHTINDENT * pixelRatioVals.dpi + 35;
      $('.bibleversion').add('.bookChapterWrapper').css({"padding-left":leftindent+"px","padding-right":rightindent+"px"});
      drawRuler(6.25,userProps.ParagraphStyles.INTERFACEINCM,userProps.ParagraphStyles.LEFTINDENT,userProps.ParagraphStyles.RIGHTINDENT);
      saveUserProps(userProps);
    });
    
    $('#paragraphalign  input[type=radio]').on('change',function(){
      if(this.checked){
        $('.liveview-quote').css({"text-align":this.value});
        userProps.ParagraphStyles.PARAGRAPHALIGN = this.value;
        saveUserProps(userProps);
      }
    });
        
    for(var i in ffAutoComplete){
      //let selcd = (ffAutoComplete[i] == userProps.FONT_FAMILY);
      $('#bibleget-font-family').append(jQuery('<option>',{value:ffAutoComplete[i],text:ffAutoComplete[i]})); //,selected:selcd
      if(i == ffAutoComplete.length-1){
        if(jQuery('#bibleget-font-family').find('option[value="<?!=userProperties.ParagraphStyles.FONT_FAMILY ?>"]').length > 0){
          jQuery('#bibleget-font-family').val('<?!=userProperties.ParagraphStyles.FONT_FAMILY ?>');
        }
        //jQuery('#bibleget-font-family').find('option[val="'+userProps.FONT_FAMILY+'"]').prop('selected',true);
        $('#bibleget-font-family').combobox()
        .combobox("widget").css({"font-family":"<?!=userProperties.ParagraphStyles.FONT_FAMILY ?>"});
        //$('#btnSetFont').button();
        jQuery('#bibleget-font-family').on('change',function(){
          //let myUI = jQuery(this).val();
          //jQuery('<span>',{text:myUI}).insertAfter('#tabs');
          userProps.ParagraphStyles.FONT_FAMILY = $(this).val();
          saveUserProps(userProps);
          $('#gfFontFamily').attr("href","https://fonts.googleapis.com/css?family="+userProps.ParagraphStyles.FONT_FAMILY+"&text="+makeUnique(userProps.ParagraphStyles.FONT_FAMILY+'<?!= UniqueStr ?>'));
          $('.bookchapter').add('.liveview-quote').css({'font-family':userProps.ParagraphStyles.FONT_FAMILY});
          $('#bibleget-font-family').combobox("widget").css({"font-family":userProps.ParagraphStyles.FONT_FAMILY});
        });
      }
    }
    
    let $pos = $('#lineheightBtn').offset();
    let $hgt = $('#lineheightBtn').height();      
    $('#Lineheight-quote').selectmenu({width:'auto',change:function(event,ui){
      $('.liveview-quote').css({"line-height":this.value+"em"});
      userProps.ParagraphStyles.LINEHEIGHT = this.value;
      saveUserProps(userProps);
      } }).selectmenu("widget").css({"display": "none"});
    $('#lineheightBtn').on('click',function(){
      let $pos = $('#lineheightBtn').offset();
      let $hgt = $('#lineheightBtn').outerHeight();      
      $('#Lineheight-quote').selectmenu('open').selectmenu('menuWidget').offset({top:($pos.top+$hgt),left:$pos.left});
    });
    
    
    /*********** TEXT STYLES for BIBLEVERSION, BOOKCHAPTER, VERSENUMBER, VERSETEXT *********
     ***********              userProperties.BookChapterStyles                     *********
     ***********              userProperties.VerseNumberStyles                     *********
     ***********              userProperties.VerseTextStyles                       *********
     **************************************************************************************/
    
    $('.textstyles input').change(function(){
      let [applyTo, textStyle] = $(this).attr('id').split('-');
      switch(textStyle){
        case '<?!=BGET.TEXTSTYLE.BOLD?>':
          let styleBold = this.checked ? 'bold' : 'normal';
          switch(applyTo){
            case 'BookChapterStyles':
              $('.bookchapter').add('.bibleversion').css({"font-weight":styleBold}); 
              userProps.BookChapterStyles.BOLD = this.checked;
              break;
            case 'VerseNumberStyles':
              $('.versenumber').css({"font-weight":styleBold});
              userProps.VerseNumberStyles.BOLD = this.checked;
              break;
            case 'VerseTextStyles':
              $('.versetext').css({"font-weight":styleBold});
              userProps.VerseTextStyles.BOLD = this.checked;
              break;
          }
          break;
        case '<?!=BGET.TEXTSTYLE.ITALIC?>':
          let styleItalic = this.checked ? 'italic' : 'normal';
          switch(applyTo){
            case 'BookChapterStyles':
              $('.bookchapter').add('.bibleversion').css({"font-style":styleItalic}); 
              userProps.BookChapterStyles.ITALIC = this.checked;
              break;
            case 'VerseNumberStyles':
              $('.versenumber').css({"font-style":styleItalic});
              userProps.VerseNumberStyles.ITALIC = this.checked;
              break;
            case 'VerseTextStyles':
              $('.versetext').css({"font-style":styleItalic});
              userProps.VerseTextStyles.ITALIC = this.checked;
              break;
          }
          break;
        case '<?!=BGET.TEXTSTYLE.UNDERLINE?>':
          let styleUnderline = '';
          switch(applyTo){
            case 'BookChapterStyles':
              styleUnderline = this.checked ? ('underline' + (userProps.BookChapterStyles.STRIKETHROUGH ? ' line-through' : '')) : (userProps.BookChapterStyles.STRIKETHROUGH ? ' line-through' : 'none');
              $('.bookchapter').add('.bibleversion').css({"text-decoration":styleUnderline}); 
              userProps.BookChapterStyles.UNDERLINE = this.checked;
              break;
            case 'VerseNumberStyles':
              styleUnderline = this.checked ? ('underline' + (userProps.VerseNumberStyles.STRIKETHROUGH ? ' line-through' : '')) : (userProps.VerseNumberStyles.STRIKETHROUGH ? ' line-through' : 'none');
              $('.versenumber').css({"text-decoration":styleUnderline});
              userProps.VerseNumberStyles.UNDERLINE = this.checked;
              break;
            case 'VerseTextStyles':
              styleUnderline = this.checked ? ('underline' + (userProps.VerseTextStyles.STRIKETHROUGH ? ' line-through' : '')) : (userProps.VerseTextStyles.STRIKETHROUGH ? ' line-through' : 'none');
              $('.versetext').css({"text-decoration":styleUnderline});
              userProps.VerseTextStyles.UNDERLINE = this.checked;
              break;
          }
          break;
        case '<?!=BGET.TEXTSTYLE.STRIKETHROUGH?>':
          let styleStrikethrough = '';
          switch(applyTo){
            case 'BookChapterStyles':
              styleStrikethrough = this.checked ? ('line-through' + (userProps.BookChapterStyles.UNDERLINE ? ' underline' : '')) : (userProps.BookChapterStyles.UNDERLINE ? ' underline' : 'none');
              $('.bookchapter').add('.bibleversion').css({"text-decoration":styleStrikethrough}); 
              userProps.BookChapterStyles.STRIKETHROUGH = this.checked;
              break;
            case 'VerseNumberStyles':
              styleStrikethrough = this.checked ? ('line-through' + (userProps.VerseNumberStyles.UNDERLINE ? ' underline' : '')) : (userProps.VerseNumberStyles.UNDERLINE ? ' underline' : 'none');
              $('.versenumber').css({"text-decoration":styleStrikethrough});
              userProps.VerseNumberStyles.STRIKETHROUGH = this.checked;
              break;
            case 'VerseTextStyles':
              styleStrikethrough = this.checked ? ('line-through' + (userProps.VerseTextStyles.UNDERLINE ? ' underline' : '')) : (userProps.VerseTextStyles.UNDERLINE ? ' underline' : 'none');
              $('.versetext').css({"text-decoration":styleStrikethrough});
              userProps.VerseTextStyles.STRIKETHROUGH = this.checked;
              break;
          }
          break;
      }
      saveUserProps(userProps);
    });
    
    $('span#BOOKCHAPTERVALIGN input').change(function(){
      if(this.checked){
        switch(this.value){
          case '<?!=BGET.VALIGN.NORMAL?>': 
            $('.bookchapter').add('.bibleversion').css({"position":"relative","top":"0px"});
            break;
          case '<?!=BGET.VALIGN.SUPERSCRIPT?>':
            $('.bookchapter').add('.bibleversion').css({"position":"relative","top":"-4px"});
            break;
          case '<?!=BGET.VALIGN.SUBSCRIPT?>':
            $('.bookchapter').add('.bibleversion').css({"position":"relative","top":"4px"});
            break;
        }
        userProps.BookChapterStyles.VALIGN = this.value; 
        saveUserProps(userProps);      
      }
      
    });

    $('span#VERSENUMBERVALIGN input').change(function(){
      if(this.checked){
        switch(this.value){
          case '<?!=BGET.VALIGN.NORMAL?>': 
            $('span.versenumber').css({"position":"relative","top":"0px"});
            break;
          case '<?!=BGET.VALIGN.SUPERSCRIPT?>':
            $('span.versenumber').css({"position":"relative","top":"-4px"});
            break;
          case '<?!=BGET.VALIGN.SUBSCRIPT?>':
            $('span.versenumber').css({"position":"relative","top":"4px"});
            break;
        }
        userProps.VerseNumberStyles.VALIGN = this.value; 
        saveUserProps(userProps);      
      }
    });
    
    $('span#VERSETEXTVALIGN input').change(function(){
      if(this.checked){
        //var thisstyle = $(this).attr('id').replace("versetext-","");
        switch(this.value){
          case '<?!=BGET.VALIGN.NORMAL?>': 
            $('span.versetext').css({"position":"relative","top":"0px"});
            break;
          case '<?!=BGET.VALIGN.SUPERSCRIPT?>':
            $('span.versetext').css({"position":"relative","top":"-4px"});
            break;
          case '<?!=BGET.VALIGN.SUBSCRIPT?>':
            $('span.versetext').css({"position":"relative","top":"4px"});
            break;
        }
        userProps.VerseTextStyles.VALIGN = this.value; 
        saveUserProps(userProps);
      }
    });    

    $('select#bookchapter-fontsize').change(function(){
      var fontsize = $(this).val() + "px";
      $('.bookchapter').add('.bibleversion').css({"font-size":fontsize});
      userProps.BookChapterStyles.FONT_SIZE = $(this).val();
      saveUserProps(userProps);
    });
        
    $('select#versenumber-fontsize').change(function(){
      var fontsize = $(this).val() + "px";
      $('span.versenumber').css({"font-size":fontsize});
      userProps.VerseNumberStyles.FONT_SIZE = $(this).val();
      saveUserProps(userProps);
    });
    
    $('select#versetext-fontsize').change(function(){
      var fontsize = $(this).val() + "px";
      $('span.versetext').css({"font-size":fontsize});
      userProps.VerseTextStyles.FONT_SIZE = $(this).val();
      saveUserProps(userProps);
    });

    $('input[type="color"]').change(function(){
      //alert($(this).val());
      var thisval = this.value;
      var thisid = $(this).attr('id').split('-');
      //alert("thisval = "+thisval+", thisid[0] = "+thisid[0]+", thisid[1] = "+thisid[1]);
      if(thisid[1]=='color'){
        $('.'+thisid[0]).css({"color":thisval});
        //google.script.run.consoleLog("thisid = "+thisid[0]+",thisval = "+thisval);
        if(thisid[0] == "bookchapter"){ userProps.BookChapterStyles.FOREGROUND_COLOR = thisval; saveUserProps(userProps); }
        if(thisid[0] == "versenumber"){ userProps.VerseNumberStyles.FOREGROUND_COLOR = thisval; saveUserProps(userProps); }
        if(thisid[0] == "versetext"){ userProps.VerseTextStyles.FOREGROUND_COLOR = thisval; saveUserProps(userProps); }
      }
      if(thisid[1]=='bgcolor'){
        $('.'+thisid[0]).css({"background-color":thisval});
        if(thisid[0] == "bookchapter"){ userProps.BookChapterStyles.BACKGROUND_COLOR = thisval; saveUserProps(userProps); }
        if(thisid[0] == "versenumber"){ userProps.VerseNumberStyles.BACKGROUND_COLOR = thisval; saveUserProps(userProps); }
        if(thisid[0] == "versetext"){ userProps.VerseTextStyles.BACKGROUND_COLOR = thisval; saveUserProps(userProps); }
      }
      
    });
    
    $('#otherSettingsTab1 input').button();    
    
    $('#NOVERSIONFORMATTING').change(function(){
      userProps.ParagraphStyles.NOVERSIONFORMATTING = this.checked;//$(this).prop("checked");
      saveUserProps(userProps);
    });
    
    $('#INTERFACEINCM').change(function(){
      //When in inches mode (default), increments will be by 0.25. When in centimeters mode, increments will be by 0.5
      //so let's convert between these two, doubling when going from inches to CM and halving the other way around
      userProps.ParagraphStyles.INTERFACEINCM = this.checked;
      userProps.ParagraphStyles.LEFTINDENT = (this.checked ? userProps.ParagraphStyles.LEFTINDENT*2 : userProps.ParagraphStyles.LEFTINDENT/2);
      userProps.ParagraphStyles.RIGHTINDENT = (this.checked ? userProps.ParagraphStyles.RIGHTINDENT*2 : userProps.ParagraphStyles.RIGHTINDENT/2);
      //leftindent = (userProps.ParagraphStyles.INTERFACEINCM ? centimetersToPoints(userProps.ParagraphStyles.LEFTINDENT) : inchesToPoints(userProps.ParagraphStyles.LEFTINDENT)) * ptToPx;   
      //convert to point size then to pixel size useful for CSS margin-left property
      //rightindent = (userProps.ParagraphStyles.INTERFACEINCM ? centimetersToPoints(userProps.ParagraphStyles.RIGHTINDENT) : inchesToPoints(userProps.ParagraphStyles.RIGHTINDENT)) * ptToPx; //convert to point size then to pixel size useful for CSS margin-right property
      let pixelRatioVals = getPixelRatioVals(6.25,userProps.ParagraphStyles.INTERFACEINCM);
      let leftindent = userProps.ParagraphStyles.LEFTINDENT * pixelRatioVals.dpi + 35;
      let rightindent = userProps.ParagraphStyles.RIGHTINDENT * pixelRatioVals.dpi + 35;
      $('.bibleversion').add('.bookChapterWrapper').css({"padding-left":leftindent+"px","padding-right":rightindent+"px"});
      drawRuler(6.25,userProps.ParagraphStyles.INTERFACEINCM,userProps.ParagraphStyles.LEFTINDENT,userProps.ParagraphStyles.RIGHTINDENT);
      saveUserProps(userProps);
    });
    
    let pixelRatioVals = getPixelRatioVals(6.25,<?!=userProperties.ParagraphStyles.INTERFACEINCM?>);
    let leftindent = <?!=userProperties.ParagraphStyles.LEFTINDENT?> * pixelRatioVals.dpi + 35;
    let rightindent = <?!=userProperties.ParagraphStyles.RIGHTINDENT?> * pixelRatioVals.dpi + 35;
    let bestWidth = 6.25 * 96 * window.devicePixelRatio + (35*2);
    $('.bibleversion').add('.bookChapterWrapper').css({"width":bestWidth+"px","padding-left":leftindent+"px","padding-right":rightindent+"px"}); 
    drawRuler(6.25,<?!=userProperties.ParagraphStyles.INTERFACEINCM?>,<?!=userProperties.ParagraphStyles.LEFTINDENT?>,<?!=userProperties.ParagraphStyles.RIGHTINDENT?>);
    
    /*******************************************************
     *                     TAB 2                           *
     ******************************************************/
    
    jQuery('#tab2 .buttonset').controlgroup({
      "direction": "vertical"
    });
    
    //We'll handle all of the radio inputs on tab2 in one go (which means pretty much all, there's only one checkbox input)
    $('#tab2').on('change','input[type=radio]', function(){
      console.log(this.name + ' = ' + this.value + '(' + typeof this.value + ')');
      if(this.checked){ 
        $('.spinner').fadeIn("fast");
        //alert(this.name + ' : ' + this.value);
        switch(this.name){
          case "SHOWBIBLEVERSION":
            switch(this.value){
              case '<?!=BGET.VISIBILITY.SHOW?>':
                jQuery('.fieldset-results').each(function(){
                  if(userProps.LayoutPrefs.BIBLEVERSIONPOSITION=='<?!=BGET.POS.TOP?>'){
                    $(this).find('p.bibleversion.showtop').show();
                    $(this).find('p.bibleversion.showbottom').hide();
                  }
                  else if(userProps.LayoutPrefs.BIBLEVERSIONPOSITION=='<?!=BGET.POS.BOTTOM?>'){
                    $(this).find('p.bibleversion.showtop').hide();
                    $(this).find('p.bibleversion.showbottom').show();
                  }
                });
                break;
              case '<?!=BGET.VISIBILITY.HIDE?>':
                jQuery('.fieldset-results').each(function(){
                  $(this).find('p.bibleversion').hide();
                });
                break;
            }
            break;
          case "BIBLEVERSIONWRAP":
            var wrap1='';
            var wrap2='';
            switch(this.value){
              case '<?!=BGET.WRAP.PARENTHESES?>':
              wrap1= '(';
              wrap2 = ')';
              break;
            case '<?!=BGET.WRAP.BRACKETS?>':
              wrap1 = '[';
              wrap2 = ']';
              break;
            }
            jQuery('p.bibleversion').each(function(){
              $(this).find('span.bcWrap').first().text(wrap1);
              $(this).find('span.bcWrap').last().text(wrap2);
            });
            break;
          case "BIBLEVERSIONALIGNMENT":
            jQuery('p.bibleversion').css({'text-align':this.value});
            break;
          case "BIBLEVERSIONPOSITION":
            switch(this.value){
              case '<?!=BGET.POS.TOP?>':
                jQuery('.fieldset-results').each(function(){
                  $(this).find('p.bibleversion.showtop').show();
                  $(this).find('p.bibleversion.showbottom').hide();
                });
                break;
              case '<?!=BGET.POS.BOTTOM?>':
                jQuery('.fieldset-results').each(function(){
                  $(this).find('p.bibleversion.showbottom').show();
                  $(this).find('p.bibleversion.showtop').hide();
                });
                break;
            }
            break;
          case "BOOKCHAPTERFORMAT":
            switch(this.value){
              case '<?!=BGET.FORMAT.BIBLELANG?>':
                bkChptr1Sam213 = "I Samuelis 2";
                bkChptrPs11412 = "Psalmorum 114";
                break;
              case '<?!=BGET.FORMAT.BIBLELANGABBREV?>':
                bkChptr1Sam213 = "ISam 2";
                bkChptrPs11412 = "Ps 114";
                break;
              case '<?!=BGET.FORMAT.USERLANG?>':
                bkChptr1Sam213 = '<?!=__('ISamuelis2',locale)?>';
                bkChptrPs11412 = '<?!=__('Psalmorum114',locale)?>';
                break;
              case '<?!=BGET.FORMAT.USERLANGABBREV?>':
                bkChptr1Sam213 = '<?!=__('ISam2',locale)?>';
                bkChptrPs11412 = '<?!=__('Ps114',locale)?>';
                break;
            }
            if(userProps.LayoutPrefs.BOOKCHAPTERFULLQUERY){
              $('.bcText1Sam').text(bkChptr1Sam213 + ('<?!=locale?>'=='en' ? ':' : ',')+'1-3');
              $('.bcTextPs').text(bkChptrPs11412 + ('<?!=locale?>'=='en' ? ':' : ',')+'1-2');
            }
            else{
              $('.bcText1Sam').text(bkChptr1Sam213);
              $('.bcTextPs').text(bkChptrPs11412);
            }
            break;
          case "BOOKCHAPTERWRAP":
            var wrap1='';
            var wrap2='';
            switch(this.value){
              case '<?!=BGET.WRAP.PARENTHESES?>':
              wrap1= '(';
              wrap2 = ')';
              break;
            case '<?!=BGET.WRAP.BRACKETS?>':
              wrap1 = '[';
              wrap2 = ']';
              break;
            }
            jQuery('.bookchapter').each(function(){
              $(this).find('span.bcWrap').first().text(wrap1);
              $(this).find('span.bcWrap').last().text(wrap2);
            });
            break;
          case "BOOKCHAPTERALIGNMENT":
            jQuery('.bookchapter').css({'text-align':this.value});
            break;
          case "BOOKCHAPTERPOSITION":
            switch(this.value){
              case '<?!=BGET.POS.TOP?>':
                jQuery('div.bookChapterWrapper').each(function(){
                  $(this).find('.bookchapter').css({'display':'block','margin-left':'0'}).prependTo(this);
                });
                break;
              case '<?!=BGET.POS.BOTTOM?>':
                jQuery('div.bookChapterWrapper').each(function(){
                  $(this).find('.bookchapter').css({'display':'block','margin-left':'0'}).appendTo(this);
                });
                break;
              case '<?!=BGET.POS.BOTTOMINLINE?>':
                console.log('bottominline was chosen alright');
                jQuery('div.bookChapterWrapper').each(function(){
                  $(this).find('.bookchapter').css({'display':'inline','margin-left':'6px'}).appendTo($(this).find('.liveview-quote'));
                });
                break;
            }
            break;
          case "SHOWVERSENUMBERS":
            switch(this.value){
              case '<?!=BGET.VISIBILITY.SHOW?>':
                jQuery('span.versenumber').show();
                break;
              case '<?!=BGET.VISIBILITY.HIDE?>':
                jQuery('span.versenumber').hide();
                break;
            }
            break;          
        }
        userProps.LayoutPrefs[this.name] = this.value;        
        saveUserProps(userProps);
      }
    });

    $('#BOOKCHAPTERFULLQUERY').button().on('change',function(){
      userProps.LayoutPrefs.BOOKCHAPTERFULLQUERY = this.checked;
      if(this.checked){
            $('.bcText1Sam').text(bkChptr1Sam213 + ('<?!=locale?>'=='en' ? ':' : ',')+'1-3');
            $('.bcTextPs').text(bkChptrPs11412 + ('<?!=locale?>'=='en' ? ':' : ',')+'1-2');
      }
      else{
            $('.bcText1Sam').text(bkChptr1Sam213);
            $('.bcTextPs').text(bkChptrPs11412);
      }
      saveUserProps(userProps);
    }).parent('label').css({"margin-top":"6px"});
    

    /*******************************************************
     *                     TAB 3                           *
     ******************************************************/
    jQuery('#tab3 .button').button();
    
    jQuery('#RESET_DEFAULT_USERPROPS').on('click',function(){
      $('.spinner').show();
      google.script.run.resetUserProperties();
    });
    
    $('#updatedata').on('click', function(){
      $('.spinner').show();
      google.script.run.refreshData();
    });

    domopscomplete = true;
    //In my tests I have seen that userProps will not be populated yet at this point
    //Any call to google.scripts services will take much longer than dom manipulation
    if(userProps.populated){ $('.spinner').fadeOut("fast"); }

});

</script>
</body>
<?
  if(CURRENTSTATE == ADDONSTATE.DEVELOPMENT){
    consoleLog('document body complete in Settings.html');
  }   
?>
